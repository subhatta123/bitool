{% extends 'base.html' %}

{% block title %}Data Sources - ConvaBI{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">
                                <i class="fas fa-database me-2"></i>
                                Data Sources
                            </h3>
                            <p class="mb-0">Connect and manage your data sources</p>
                        </div>
                        <div class="d-flex align-items-center">
                            <a href="{% url 'datasets:integration' %}" class="btn btn-outline-light me-3">
                                Next: Data Integration <i class="fas fa-arrow-right ms-2"></i>
                            </a>
                            <div class="dropdown">
                                <button class="btn btn-success dropdown-toggle" type="button" 
                                        data-bs-toggle="dropdown" aria-expanded="false">
                                    <i class="fas fa-plus"></i> Add Data Source
                                </button>
                                <ul class="dropdown-menu">
                                    <li><a class="dropdown-item" href="#" onclick="showConnectionModal('csv')">
                                        <i class="fas fa-file-csv text-success"></i> CSV File
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="showConnectionModal('postgresql')">
                                        <i class="fas fa-elephant text-primary"></i> PostgreSQL
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="showConnectionModal('mysql')">
                                        <i class="fas fa-database text-warning"></i> MySQL
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="showConnectionModal('oracle')">
                                        <i class="fas fa-database text-danger"></i> Oracle
                                    </a></li>
                                    <li><a class="dropdown-item" href="#" onclick="showConnectionModal('sqlserver')">
                                        <i class="fas fa-server text-info"></i> SQL Server
                                    </a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><a class="dropdown-item" href="#" onclick="showConnectionModal('api')">
                                        <i class="fas fa-cloud text-secondary"></i> REST API
                                    </a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <!-- Workflow Guide for First Time Users -->
                    {% if not data_sources %}
                        <div class="alert alert-info border-0 bg-gradient-primary text-white mb-4">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h5><i class="fas fa-rocket me-2"></i>Welcome to ConvaBI!</h5>
                                    <p class="mb-0">Get started with AI-powered data analysis in just 3 simple steps:</p>
                                </div>
                                <div class="col-md-4 text-center">
                                    <button class="btn btn-light btn-lg" onclick="showConnectionModal('csv')">
                                        <i class="fas fa-play me-2"></i>Start Now
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <div class="text-center p-4 bg-light rounded">
                                    <div class="bg-primary text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                        <span class="h4 mb-0">1</span>
                                    </div>
                                    <h5>Connect Your Data</h5>
                                    <p class="text-muted">Upload CSV files or connect to databases like PostgreSQL, MySQL, Oracle</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-4 bg-light rounded">
                                    <div class="bg-success text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                        <span class="h4 mb-0">2</span>
                                    </div>
                                    <h5>Ask Questions</h5>
                                    <p class="text-muted">Use natural language to query your data - no SQL knowledge required</p>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="text-center p-4 bg-light rounded">
                                    <div class="bg-info text-white rounded-circle d-inline-flex align-items-center justify-content-center mb-3" style="width: 60px; height: 60px;">
                                        <span class="h4 mb-0">3</span>
                                    </div>
                                    <h5>Create Dashboards</h5>
                                    <p class="text-muted">Build beautiful visualizations and share insights with your team</p>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Progress Tracker for Existing Users -->
                    {% if data_sources %}
                        <div class="alert alert-success border-0 mb-4">
                            <div class="row align-items-center">
                                <div class="col-md-8">
                                    <h6><i class="fas fa-check-circle me-2"></i>Great! You have {{ data_sources|length }} data source{{ data_sources|length|pluralize }} connected</h6>
                                    <div class="progress mt-2" style="height: 6px;">
                                        <div class="progress-bar bg-success" role="progressbar" style="width: 33%"></div>
                                        <div class="progress-bar bg-info" role="progressbar" style="width: 33%"></div>
                                        <div class="progress-bar bg-light" role="progressbar" style="width: 34%"></div>
                                    </div>
                                    <small class="text-muted mt-1 d-block">Ready to query → Setup semantics → Create dashboards</small>
                                </div>
                                <div class="col-md-4 text-end">
                                    <a href="{% url 'core:query' %}" class="btn btn-success me-2">
                                        <i class="fas fa-search me-1"></i>Query Data
                                    </a>
                                                        <button class="btn btn-outline-primary" onclick="showConnectionModal('csv')">
                        <i class="fas fa-plus me-1"></i>Add More
                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Data Sources List -->
                        <div class="row">
                            {% for source in data_sources %}
                                <div class="col-md-6 col-lg-4 mb-4">
                                    <div class="card h-100 shadow-sm">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start mb-3">
                                                <div>
                                                    <h5 class="card-title mb-1">{{ source.name }}</h5>
                                                    {% if source.source_type == 'csv' %}
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-file-csv"></i>
                                                            {{ source.source_type|title }}
                                                        </span>
                                                    {% elif source.source_type == 'postgresql' %}
                                                        <span class="badge bg-primary">
                                                            <i class="fas fa-elephant"></i>
                                                            {{ source.source_type|title }}
                                                        </span>
                                                    {% elif source.source_type == 'mysql' %}
                                                        <span class="badge bg-warning">
                                                            <i class="fas fa-database"></i>
                                                            {{ source.source_type|title }}
                                                        </span>
                                                    {% elif source.source_type == 'oracle' %}
                                                        <span class="badge bg-danger">
                                                            <i class="fas fa-database"></i>
                                                            {{ source.source_type|title }}
                                                        </span>
                                                    {% elif source.source_type == 'sqlserver' %}
                                                        <span class="badge bg-info">
                                                            <i class="fas fa-server"></i>
                                                            {{ source.source_type|title }}
                                                        </span>
                                                    {% elif source.source_type == 'api' %}
                                                        <span class="badge bg-secondary">
                                                            <i class="fas fa-cloud"></i>
                                                            {{ source.source_type|title }}
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-secondary">
                                                            <i class="fas fa-database"></i>
                                                            {{ source.source_type|title }}
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <div class="dropdown">
                                                    <button class="btn btn-sm btn-outline-secondary dropdown-toggle" 
                                                            type="button" data-bs-toggle="dropdown">
                                                        <i class="fas fa-ellipsis-v"></i>
                                                    </button>
                                                    <ul class="dropdown-menu">
                                                        <li><a class="dropdown-item" href="{% url 'datasets:detail' source.id %}"><i class="fas fa-eye"></i> View Details</a></li>
                                                        {% if source.created_by == request.user %}
                                                            <li><a class="dropdown-item" href="{% url 'datasets:edit' source.id %}"><i class="fas fa-edit"></i> Edit</a></li>
                                                            <li><a class="dropdown-item" href="{% url 'datasets:share' source.id %}"><i class="fas fa-share-alt"></i> Share</a></li>
                                                            <li><hr class="dropdown-divider"></li>
                                                            <li><a class="dropdown-item text-danger" href="#" onclick="deleteSource('{{ source.id }}')"><i class="fas fa-trash"></i> Delete</a></li>
                                                        {% endif %}
                                                    </ul>
                                                </div>
                                            </div>
                                            
                                            <p class="card-text text-muted">{{ source.description|truncatewords:15 }}</p>
                                            
                                            <div class="mb-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <small class="text-muted">Status:</small>
                                                    {% if source.status == 'active' %}
                                                        <span class="badge bg-success">
                                                            <i class="fas fa-circle"></i>
                                                            Active
                                                        </span>
                                                    {% else %}
                                                        <span class="badge bg-danger">
                                                            <i class="fas fa-circle"></i>
                                                            Inactive
                                                        </span>
                                                    {% endif %}
                                                </div>
                                                <div class="d-flex justify-content-between align-items-center mt-1">
                                                    <small class="text-muted">Last Used:</small>
                                                    <small class="text-muted">{{ source.last_accessed|timesince|default:'Never' }} ago</small>
                                                </div>
                                            </div>
                                            
                            <!-- Mandatory Workflow Progression -->
                            <div class="workflow-progress mb-3">
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <small class="text-muted">Workflow Progress</small>
                                    <small class="text-muted">{{ source.workflow_status.progress_percentage|default:20 }}%</small>
                                </div>
                                <div class="progress" style="height: 4px;">
                                    <div class="progress-bar" role="progressbar" 
                                         style="width: {{ source.workflow_status.progress_percentage|default:20 }}%"></div>
                                </div>
                            </div>
                            
                            <div class="workflow-steps">
                                <!-- Step 1: Data Loaded (Always completed for existing sources) -->
                                <div class="workflow-step completed mb-2" onclick="navigateToDataLoad('{{ source.id }}')">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <small class="text-success">
                                        <a href="{% url 'datasets:detail' source.id %}" class="text-decoration-none text-success">
                                            Data Loaded
                                        </a>
                                    </small>
                                    <span class="badge bg-success ms-auto">✓</span>
                                </div>
                                
                                <!-- Step 2: ETL Processing -->
                                {% if source.workflow_status.etl_completed %}
                                    <div class="workflow-step completed mb-2" onclick="navigateToETL('{{ source.id }}')">
                                        <i class="fas fa-check-circle text-success me-2"></i>
                                        <small class="text-success">
                                            <a href="{% url 'datasets:integration' %}?source={{ source.id }}" class="text-decoration-none text-success">
                                                ETL Completed
                                            </a>
                                        </small>
                                        <span class="badge bg-success ms-auto">✓</span>
                                    </div>
                                {% else %}
                                    <div class="workflow-step current mb-2">
                                        <i class="fas fa-circle text-warning me-2"></i>
                                        <small class="text-warning">ETL Required</small>
                                        <span class="badge bg-warning ms-auto">!</span>
                                    </div>
                                    <div class="d-grid gap-1">
                                        <a href="{% url 'datasets:integration' %}?source={{ source.id }}" class="btn btn-warning btn-sm">
                                            <i class="fas fa-cogs"></i> Start ETL Process
                                        </a>
                                    </div>
                                {% endif %}
                                
                                <!-- Step 3: Semantic Layer Generation -->
                                {% if source.workflow_status.etl_completed %}
                                    {% if source.workflow_status.semantics_completed %}
                                        <div class="workflow-step completed mb-2" onclick="navigateToSemantics('{{ source.id }}')">
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            <small class="text-success">
                                                <a href="{% url 'datasets:semantic' %}?source={{ source.id }}" class="text-decoration-none text-success">
                                                    Semantic Layer Ready
                                                </a>
                                            </small>
                                            <span class="badge bg-success ms-auto">✓</span>
                                        </div>
                                    {% else %}
                                        <div class="workflow-step current mb-2">
                                            <i class="fas fa-circle text-info me-2"></i>
                                            <small class="text-info">Generate Semantic Layer</small>
                                            <span class="badge bg-info ms-auto">?</span>
                                        </div>
                                        <div class="d-grid gap-1">
                                            <button class="btn btn-info btn-sm" onclick="generateSemanticLayer('{{ source.id }}')">
                                                <i class="fas fa-brain"></i> Auto-Generate Semantics
                                            </button>
                                            <a href="{% url 'datasets:semantic' %}?source={{ source.id }}" class="btn btn-outline-info btn-sm">
                                                <i class="fas fa-eye"></i> View Semantic Layer
                                            </a>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="workflow-step disabled mb-2">
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <small class="text-muted">Semantic Layer (ETL Required)</small>
                                        <span class="badge bg-secondary ms-auto">-</span>
                                    </div>
                                {% endif %}
                                
                                <!-- Step 4: Query with AI -->
                                {% if source.workflow_status.semantics_completed %}
                                    {% if source.workflow_status.query_enabled %}
                                        <div class="workflow-step completed mb-2" onclick="navigateToQuery('{{ source.id }}')">
                                            <i class="fas fa-check-circle text-success me-2"></i>
                                            <small class="text-success">
                                                <a href="{% url 'core:query' %}?source={{ source.id }}" class="text-decoration-none text-success">
                                                    Query Ready
                                                </a>
                                            </small>
                                            <span class="badge bg-success ms-auto">✓</span>
                                        </div>
                                        <div class="d-grid gap-1">
                                            <a href="{% url 'core:query' %}?source={{ source.id }}" class="btn btn-primary btn-sm">
                                                <i class="fas fa-robot"></i> Query with AI
                                            </a>
                                        </div>
                                    {% else %}
                                        <div class="workflow-step current mb-2">
                                            <i class="fas fa-circle text-primary me-2"></i>
                                            <small class="text-primary">Ready for Querying</small>
                                            <span class="badge bg-primary ms-auto">→</span>
                                        </div>
                                        <div class="d-grid gap-1">
                                            <a href="{% url 'core:query' %}?source={{ source.id }}" class="btn btn-primary btn-sm">
                                                <i class="fas fa-robot"></i> Start Querying
                                            </a>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="workflow-step disabled mb-2">
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <small class="text-muted">Query (Semantics Required)</small>
                                        <span class="badge bg-secondary ms-auto">-</span>
                                    </div>
                                {% endif %}
                                
                                <!-- Step 5: Dashboard -->
                                {% if source.workflow_status.query_enabled %}
                                    <div class="workflow-step {% if source.workflow_status.dashboard_enabled %}completed{% else %}current{% endif %} mb-2" 
                                         onclick="{% if source.workflow_status.dashboard_enabled %}navigateToDashboard('{{ source.id }}'){% endif %}">
                                        <i class="fas fa-{% if source.workflow_status.dashboard_enabled %}check-circle text-success{% else %}circle text-secondary{% endif %} me-2"></i>
                                        <small class="text-{% if source.workflow_status.dashboard_enabled %}success{% else %}secondary{% endif %}">
                                            {% if source.workflow_status.dashboard_enabled %}
                                                <a href="{% url 'dashboards:list' %}?source={{ source.id }}" class="text-decoration-none text-success">
                                                    Dashboard Available
                                                </a>
                                            {% else %}
                                                Ready for Dashboard
                                            {% endif %}
                                        </small>
                                        <span class="badge bg-{% if source.workflow_status.dashboard_enabled %}success{% else %}secondary{% endif %} ms-auto">
                                            {% if source.workflow_status.dashboard_enabled %}✓{% else %}→{% endif %}
                                        </span>
                                    </div>
                                    {% if not source.workflow_status.dashboard_enabled %}
                                        <div class="d-grid gap-1">
                                            <a href="{% url 'dashboards:create' %}?source={{ source.id }}" class="btn btn-secondary btn-sm">
                                                <i class="fas fa-chart-bar"></i> Create Dashboard
                                            </a>
                                        </div>
                                    {% endif %}
                                {% else %}
                                    <div class="workflow-step disabled mb-2">
                                        <i class="fas fa-circle text-muted me-2"></i>
                                        <small class="text-muted">Dashboard (Query Required)</small>
                                        <span class="badge bg-secondary ms-auto">-</span>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
                    {% else %}
                    {% endif %}

                    <!-- Workflow Information -->
                    <div class="mt-4 pt-3 border-top">
                        <div class="alert alert-info">
                            <h6><i class="fas fa-info-circle me-2"></i>Mandatory Workflow</h6>
                            <p class="mb-0">Follow the step-by-step process for each data source: 
                                <strong>Data Upload → ETL → Semantic Layer → Query with Ollama → Dashboard</strong>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Connection Modals -->
<!-- Enhanced CSV Upload Modal -->
<div class="modal fade" id="csvModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-file-csv text-success"></i> Upload CSV File
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <!-- Smart Upload Content -->
                <div id="smartUploadContent">
                    <!-- Progress Steps -->
                    <div class="mb-4">
                        <div class="progress mb-3">
                            <div class="progress-bar" role="progressbar" style="width: 25%" id="uploadProgressBar"></div>
                        </div>
                        <div class="d-flex justify-content-between">
                            <span class="badge bg-primary" id="step1">1. Upload File</span>
                            <span class="badge bg-secondary" id="step2">2. Analyze Structure</span>
                            <span class="badge bg-secondary" id="step3">3. Configure Parsing</span>
                            <span class="badge bg-secondary" id="step4">4. Preview & Import</span>
                        </div>
                    </div>
                    
                    <!-- Step 1: File Upload -->
                    <div id="uploadStep" class="step-content">
                        <h6><i class="fas fa-upload me-2"></i>Step 1: Upload CSV File</h6>
                        <form id="csvForm" enctype="multipart/form-data">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="csvName" class="form-label">Data Source Name</label>
                                        <input type="text" class="form-control" id="csvName" name="name" required>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label for="csvDescription" class="form-label">Description</label>
                                        <textarea class="form-control" id="csvDescription" name="description" rows="2"></textarea>
                                    </div>
                                </div>
                            </div>
                            <div class="mb-3">
                                <label for="csvFile" class="form-label">Select CSV File</label>
                                <input type="file" class="form-control" id="csvFile" name="csv_file" accept=".csv" required>
                                <div class="form-text">
                                    Supported formats: CSV files up to 100MB. 
                                    <span class="text-primary">Processing will automatically detect column structures.</span>
                                </div>
                            </div>
                            <div class="d-grid">
                                <button type="button" class="btn btn-primary" onclick="analyzeCSVStructure()">
                                    <i class="fas fa-search me-2"></i>Analyze CSV Structure
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Advanced mode steps (hidden initially) -->
                    <div id="analysisStep" class="step-content" style="display: none;">
                        <h6><i class="fas fa-chart-bar me-2"></i>Step 2: CSV Structure Analysis</h6>
                        <div id="analysisResults"></div>
                    </div>
                    
                    <div id="configStep" class="step-content" style="display: none;">
                        <h6><i class="fas fa-cogs me-2"></i>Step 3: Configure Parsing Options</h6>
                        <div id="advancedConfigContent"></div>
                    </div>
                    
                    <div id="previewStep" class="step-content" style="display: none;">
                        <h6><i class="fas fa-eye me-2"></i>Step 4: Preview & Import</h6>
                        <div id="previewResults"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <!-- Next Step button - hidden on step 1, visible on steps 2, 3, 4 -->
                <button type="button" class="btn btn-primary" id="nextStepBtn" onclick="nextStep()" style="display: none;">
                    Next Step <i class="fas fa-arrow-right ms-2"></i>
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Database Connection Modal -->
<div class="modal fade" id="databaseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="databaseModalTitle">
                    <i class="fas fa-database"></i> Database Connection
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="databaseForm">
                <div class="modal-body">
                    <input type="hidden" id="dbType" name="source_type">
                    
                    <div class="mb-3">
                        <label for="dbName" class="form-label">Connection Name</label>
                        <input type="text" class="form-control" id="dbName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="dbDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="dbDescription" name="description" rows="2"></textarea>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-8">
                            <div class="mb-3">
                                <label for="dbHost" class="form-label">Host</label>
                                <input type="text" class="form-control" id="dbHost" name="host" placeholder="localhost" required>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label for="dbPort" class="form-label">Port</label>
                                <input type="number" class="form-control" id="dbPort" name="port" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dbDatabase" class="form-label">Database Name</label>
                                <input type="text" class="form-control" id="dbDatabase" name="database" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dbSchema" class="form-label">Schema (Optional)</label>
                                <input type="text" class="form-control" id="dbSchema" name="schema">
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dbUsername" class="form-label">Username</label>
                                <input type="text" class="form-control" id="dbUsername" name="username" required>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="dbPassword" class="form-label">Password</label>
                                <input type="password" class="form-control" id="dbPassword" name="password" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info">
                        <i class="fas fa-shield-alt"></i>
                        <strong>Security:</strong> Credentials are encrypted and stored securely.
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="testDatabaseConnection()">
                        <i class="fas fa-plug"></i> Test Connection
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Connection
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- API Connection Modal -->
<div class="modal fade" id="apiModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-cloud text-secondary"></i> REST API Connection
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="apiForm">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="apiName" class="form-label">API Connection Name</label>
                        <input type="text" class="form-control" id="apiName" name="name" required>
                    </div>
                    <div class="mb-3">
                        <label for="apiDescription" class="form-label">Description</label>
                        <textarea class="form-control" id="apiDescription" name="description" rows="2"></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="apiUrl" class="form-label">API Base URL</label>
                        <input type="url" class="form-control" id="apiUrl" name="api_url" placeholder="https://api.example.com/v1" required>
                    </div>
                    <div class="mb-3">
                        <label for="apiAuth" class="form-label">Authentication Type</label>
                        <select class="form-select" id="apiAuth" name="auth_type">
                            <option value="none">No Authentication</option>
                            <option value="apikey">API Key</option>
                            <option value="bearer">Bearer Token</option>
                            <option value="basic">Basic Auth</option>
                        </select>
                    </div>
                    <div id="apiAuthFields"></div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline-primary" onclick="testApiConnection()">
                        <i class="fas fa-plug"></i> Test Connection
                    </button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Save Connection
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
const dbPorts = {
    'postgresql': 5432,
    'mysql': 3306,
    'oracle': 1521,
    'sqlserver': 1433
};

function showConnectionModal(type) {
    if (type === 'csv') {
        new bootstrap.Modal(document.getElementById('csvModal')).show();
    } else if (type === 'api') {
        new bootstrap.Modal(document.getElementById('apiModal')).show();
    } else {
        // Database connection
        document.getElementById('dbType').value = type;
        document.getElementById('databaseModalTitle').innerHTML = 
            `<i class="fas fa-database"></i> ${type.charAt(0).toUpperCase() + type.slice(1)} Connection`;
        document.getElementById('dbPort').value = dbPorts[type] || '';
        new bootstrap.Modal(document.getElementById('databaseModal')).show();
    }
}

function testConnection(sourceId) {
    const btn = event.target.closest('button');
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    btn.disabled = true;
    
    fetch(`/datasets/${sourceId}/test-connection/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': ConvaBI.getCsrfToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.error || 'Connection test failed');
        }
    })
    .catch(error => {
        showAlert('danger', 'Error testing connection: ' + error.message);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function deleteSource(sourceId) {
    if (confirm('Are you sure you want to delete this data source? This and all related data will be permanently removed.')) {
        fetch(`/datasets/${sourceId}/`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': ConvaBI.getCsrfToken()
            }
        })
        .then(response => {
            if (response.ok) {
                location.reload();
            } else {
                alert('Failed to delete data source.');
            }
        });
    }
}

function testDatabaseConnection() {
    const form = document.getElementById('databaseForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    btn.disabled = true;
    
    fetch('/datasets/test/database/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': ConvaBI.getCsrfToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.error || 'Connection test failed');
        }
    })
    .catch(error => {
        showAlert('danger', 'Error testing connection: ' + error.message);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function testApiConnection() {
    const form = document.getElementById('apiForm');
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    btn.disabled = true;
    
    fetch('/datasets/test/api/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': ConvaBI.getCsrfToken(),
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
        } else {
            showAlert('danger', data.error || 'Connection test failed');
        }
    })
    .catch(error => {
        showAlert('danger', 'Error testing connection: ' + error.message);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

// Form submissions
document.getElementById('csvForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
    submitBtn.disabled = true;
    
    fetch('/datasets/upload/csv/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': ConvaBI.getCsrfToken()
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('csvModal')).hide();
            setTimeout(() => {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    location.reload();
                }
            }, 1000);
        } else {
            showAlert('danger', data.error || 'Upload failed');
        }
    })
    .catch(error => {
        showAlert('danger', 'Error uploading file: ' + error.message);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

document.getElementById('databaseForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
    submitBtn.disabled = true;
    
    fetch('/datasets/create/database/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': ConvaBI.getCsrfToken()
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('databaseModal')).hide();
            setTimeout(() => {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    location.reload();
                }
            }, 1000);
        } else {
            showAlert('danger', data.error || 'Connection failed');
        }
    })
    .catch(error => {
        showAlert('danger', 'Error creating connection: ' + error.message);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

document.getElementById('apiForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(this);
    const submitBtn = this.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    
    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Connecting...';
    submitBtn.disabled = true;
    
    fetch('/datasets/create/api/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': ConvaBI.getCsrfToken()
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('success', data.message);
            bootstrap.Modal.getInstance(document.getElementById('apiModal')).hide();
            setTimeout(() => {
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    location.reload();
                }
            }, 1000);
        } else {
            showAlert('danger', data.error || 'Connection failed');
        }
    })
    .catch(error => {
        showAlert('danger', 'Error creating connection: ' + error.message);
    })
    .finally(() => {
        submitBtn.innerHTML = originalText;
        submitBtn.disabled = false;
    });
});

// API auth fields dynamic display
document.getElementById('apiAuth').addEventListener('change', function() {
    const authType = this.value;
    const fieldsContainer = document.getElementById('apiAuthFields');
    
    let fieldsHtml = '';
    if (authType === 'apikey') {
        fieldsHtml = `
            <div class="mb-3">
                <label for="apiKey" class="form-label">API Key</label>
                <input type="password" class="form-control" id="apiKey" name="api_key" required>
            </div>
            <div class="mb-3">
                <label for="apiKeyHeader" class="form-label">Header Name</label>
                <input type="text" class="form-control" id="apiKeyHeader" name="api_key_header" value="X-API-Key">
            </div>
        `;
    } else if (authType === 'bearer') {
        fieldsHtml = `
            <div class="mb-3">
                <label for="bearerToken" class="form-label">Bearer Token</label>
                <input type="password" class="form-control" id="bearerToken" name="bearer_token" required>
            </div>
        `;
    } else if (authType === 'basic') {
        fieldsHtml = `
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="basicUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="basicUsername" name="basic_username" required>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="basicPassword" class="form-label">Password</label>
                        <input type="password" class="form-control" id="basicPassword" name="basic_password" required>
                    </div>
                </div>
            </div>
        `;
    }
    fieldsContainer.innerHTML = fieldsHtml;
});

// Enhanced navigation functions
function navigateToDataLoad(sourceId) {
    window.location.href = `/datasets/${sourceId}/`;
}

function navigateToETL(sourceId) {
    window.location.href = `/datasets/integration/?source=${sourceId}`;
}

function navigateToSemantics(sourceId) {
    window.location.href = `/datasets/semantic/?source=${sourceId}`;
}

function navigateToQuery(sourceId) {
    window.location.href = `/query/?source=${sourceId}`;
}

function navigateToDashboard(sourceId) {
    window.location.href = `/dashboards/?source=${sourceId}`;
}

// Enhanced workflow functions
function generateSemanticLayer(sourceId) {
    const btn = event.target;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Generating...';
    btn.disabled = true;
    
    fetch(`/datasets/${sourceId}/generate-semantic/`, {
        method: 'POST',
        headers: {
            'X-CSRFToken': ConvaBI.getCsrfToken(),
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            const message = data.details ? 
                `Semantic layer generated! ${data.details.tables_created} tables and ${data.details.metrics_created} metrics created.` :
                'Semantic layer generated successfully!';
            showAlert('success', message);
            setTimeout(() => location.reload(), 1500);
        } else {
            let errorMsg = data.error || 'Failed to generate semantic layer';
            if (data.details && Array.isArray(data.details)) {
                errorMsg += ': ' + data.details.join(', ');
            }
            if (data.debug_info) {
                console.error('Semantic generation debug info:', data.debug_info);
            }
            showAlert('danger', errorMsg);
        }
    })
    .catch(error => {
        showAlert('danger', 'Error generating semantic layer: ' + error.message);
    })
    .finally(() => {
        btn.innerHTML = originalText;
        btn.disabled = false;
    });
}

function checkWorkflowProgress(sourceId) {
    // Show workflow status in a modal or tooltip
    const progressInfo = `
        <div class="workflow-help">
            <h6>Workflow Steps:</h6>
            <ol>
                <li><strong>Data Load:</strong> Upload or connect your data source</li>
                <li><strong>ETL:</strong> Process and transform your data</li>
                <li><strong>Semantics:</strong> Generate business metadata and metrics</li>
                <li><strong>Query:</strong> Ask questions using natural language</li>
                <li><strong>Dashboard:</strong> Create visualizations and reports</li>
            </ol>
        </div>
    `;
    showAlert('info', progressInfo);
}

// Utility functions
function getCsrfToken() {
    const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]');
    if (csrfToken) {
        return csrfToken.value;
    }
    return '';
}

function showAlert(type, message) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    
    const alertContainer = document.createElement('div');
    alertContainer.innerHTML = alertHtml;
    document.body.insertBefore(alertContainer.firstElementChild, document.body.firstChild);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        const alert = document.querySelector('.alert');
        if (alert) {
            alert.remove();
        }
    }, 5000);
}

// Ensure ConvaBI getCsrfToken function is available
window.ConvaBI = window.ConvaBI || {};
if (!window.ConvaBI.getCsrfToken) {
    window.ConvaBI.getCsrfToken = function() {
        return window.ConvaBI.csrfToken || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    };
}

// CSV Upload Smart Mode Handling
document.addEventListener('DOMContentLoaded', function() {
    // Initialize smart upload mode
    const smartUploadContent = document.getElementById('smartUploadContent');
    if (smartUploadContent) {
        showStep(1); // Start with step 1
    }
    
    // Clear form data when modal is closed or cancelled
    const csvModal = document.getElementById('csvModal');
    if (csvModal) {
        csvModal.addEventListener('hidden.bs.modal', function () {
            clearCSVFormData();
        });
    }
});

// CSV Processing Variables
let currentStep = 1;
let csvAnalysisData = null;
let csvFile = null;

function showStep(stepNumber) {
    // Hide all steps
    document.querySelectorAll('.step-content').forEach(step => {
        step.style.display = 'none';
    });
    
    // Show current step
    const stepElement = document.getElementById(getStepId(stepNumber));
    if (stepElement) {
        stepElement.style.display = 'block';
    }
    
    // Update progress bar
    const progressBar = document.getElementById('uploadProgressBar');
    if (progressBar) {
        progressBar.style.width = `${stepNumber * 25}%`;
    }
    
    // Update step badges
    for (let i = 1; i <= 4; i++) {
        const stepBadge = document.getElementById(`step${i}`);
        if (stepBadge) {
            if (i < stepNumber) {
                stepBadge.className = 'badge bg-success';
            } else if (i === stepNumber) {
                stepBadge.className = 'badge bg-primary';
            } else {
                stepBadge.className = 'badge bg-secondary';
            }
        }
    }
    
    // Show/hide next button based on step
    const nextBtn = document.getElementById('nextStepBtn');
    if (nextBtn) {
        if (stepNumber === 1) {
            // Hide on step 1 - users click "Analyze CSV Structure" instead
            nextBtn.style.display = 'none';
        } else if (stepNumber === 4) {
            // Hide on final step - users click "Import Data" button in the preview
            nextBtn.style.display = 'none';
        } else {
            // Show on steps 2 and 3
            nextBtn.style.display = 'inline-block';
        }
    }
    
    currentStep = stepNumber;
}

function getStepId(stepNumber) {
    const stepIds = ['', 'uploadStep', 'analysisStep', 'configStep', 'previewStep'];
    return stepIds[stepNumber];
}

function nextStep() {
    if (currentStep < 4) {
        showStep(currentStep + 1);
    }
}

function analyzeCSVStructure() {
    console.log('Starting CSV analysis...');
    const fileInput = document.getElementById('csvFile');
    const nameInput = document.getElementById('csvName');
    
    if (!fileInput.files[0]) {
        alert('Please select a CSV file first.');
        return;
    }
    
    if (!nameInput.value.trim()) {
        alert('Please enter a data source name.');
        return;
    }
    
    csvFile = fileInput.files[0];
    console.log('CSV file selected:', csvFile.name, 'Size:', csvFile.size);
    
    const formData = new FormData();
    formData.append('csv_file', csvFile);
    
    // Show loading
    const analysisResults = document.getElementById('analysisResults');
    analysisResults.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Analyzing...</span>
            </div>
            <p class="mt-2">Analyzing CSV structure...</p>
        </div>
    `;
    
    // Move to analysis step
    showStep(2);
    
    console.log('Sending request to /datasets/api/csv/analyze/');
    fetch('/datasets/api/csv/analyze/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': window.ConvaBI.getCsrfToken()
        },
        body: formData
    })
    .then(response => {
        console.log('Analysis response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Analysis response data:', data);
        if (data.success) {
            csvAnalysisData = data.analysis;
            console.log('Analysis data stored:', csvAnalysisData);
            
            // Show warning if there were analysis issues
            if (data.warning) {
                analysisResults.innerHTML = `
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        <strong>Warning:</strong> ${data.warning}
                        <p class="mb-0 mt-2">Don't worry - our system can handle these inconsistencies during processing.</p>
                    </div>
                `;
            }
            
            displayAnalysisResults(csvAnalysisData);
            setupAdvancedConfiguration(csvAnalysisData);
            
            // Make sure Next Step button is visible now that we're on step 2
            const nextBtn = document.getElementById('nextStepBtn');
            if (nextBtn) {
                nextBtn.style.display = 'inline-block';
            }
        } else {
            console.error('Analysis failed:', data.error);
            
            // Check if user can continue despite the error
            const canContinue = data.can_continue || false;
            
            let errorHtml = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error:</strong> ${data.error || 'Unknown error'}
                </div>
            `;
            
            if (canContinue) {
                errorHtml += `
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>You can still continue:</strong> Click "Next Step" to proceed with default settings.
                        Our system will handle the file formatting issues during upload.
                    </div>
                    <div class="text-center mt-3">
                        <button type="button" class="btn btn-primary" onclick="proceedWithDefaults()">
                            <i class="fas fa-arrow-right me-2"></i>Continue with Default Settings
                        </button>
                    </div>
                `;
            }
            
            analysisResults.innerHTML = errorHtml;
        }
    })
    .catch(error => {
        console.error('Analysis request failed:', error);
        analysisResults.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message}
            </div>
        `;
    });
}

function displayAnalysisResults(analysis) {
    const resultsContainer = document.getElementById('analysisResults');
    
    let html = `
        <div class="alert alert-success">
            <i class="fas fa-check-circle me-2"></i>
            Analysis complete! Found <strong>${analysis.estimated_columns} columns</strong> and <strong>${analysis.estimated_rows} rows</strong>.
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-info-circle text-primary me-2"></i>File Information
                        </h6>
                        <ul class="list-unstyled">
                            <li><strong>Delimiter:</strong> <code>${analysis.delimiter}</code></li>
                            <li><strong>Encoding:</strong> ${analysis.encoding}</li>
                            <li><strong>Has Header:</strong> ${analysis.has_header ? 'Yes' : 'No'}</li>
                        </ul>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-body">
                        <h6 class="card-title">
                            <i class="fas fa-table text-success me-2"></i>Preview
                        </h6>
                        <div class="table-responsive">
                            <table class="table table-sm">
                                <thead>
                                    <tr>
                                        ${analysis.column_names.slice(0, 3).map(col => `<th>${col}</th>`).join('')}
                                        ${analysis.column_names.length > 3 ? '<th>...</th>' : ''}
                                    </tr>
                                </thead>
                                <tbody>
                                    ${analysis.sample_preview.slice(0, 3).map(row => `
                                        <tr>
                                            ${analysis.column_names.slice(0, 3).map(col => `<td>${row[col] || ''}</td>`).join('')}
                                            ${analysis.column_names.length > 3 ? '<td>...</td>' : ''}
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    if (analysis.nested_columns && Object.keys(analysis.nested_columns).length > 0) {
        html += `
            <div class="row mt-3">
                <div class="col-12">
                    <div class="alert alert-warning">
                        <h6><i class="fas fa-magic me-2"></i>Smart Column Detection</h6>
                        <p class="mb-2">Found <strong>${Object.keys(analysis.nested_columns).length} columns</strong> with comma-separated values that can be split:</p>
                        ${Object.entries(analysis.nested_columns).map(([colName, colInfo]) => `
                            <div class="mb-2">
                                <strong>${colName}:</strong> 
                                <code>${colInfo.sample_values[0] || 'N/A'}</code>
                                <small class="text-muted">(can split into ${colInfo.estimated_sub_columns} columns)</small>
                            </div>
                        `).join('')}
                        <p class="mb-0">Configure these options in the next step.</p>
                    </div>
                </div>
            </div>
        `;
    }
    
    resultsContainer.innerHTML = html;
}

function setupAdvancedConfiguration(analysis) {
    const configContainer = document.getElementById('advancedConfigContent');
    
    let html = `
        <div class="row">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-sliders-h me-2"></i>Basic Options</h6>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <label class="form-label">Delimiter</label>
                            <select class="form-select" id="csvDelimiter">
                                <option value="," ${analysis.delimiter === ',' ? 'selected' : ''}>Comma (,)</option>
                                <option value=";" ${analysis.delimiter === ';' ? 'selected' : ''}>Semicolon (;)</option>
                                <option value="\t" ${analysis.delimiter === '\t' ? 'selected' : ''}>Tab</option>
                                <option value="|" ${analysis.delimiter === '|' ? 'selected' : ''}>Pipe (|)</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Encoding</label>
                            <select class="form-select" id="csvEncoding">
                                <option value="utf-8" ${analysis.encoding === 'utf-8' ? 'selected' : ''}>UTF-8</option>
                                <option value="latin-1" ${analysis.encoding === 'latin-1' ? 'selected' : ''}>Latin-1</option>
                                <option value="iso-8859-1" ${analysis.encoding === 'iso-8859-1' ? 'selected' : ''}>ISO-8859-1</option>
                                <option value="cp1252" ${analysis.encoding === 'cp1252' ? 'selected' : ''}>Windows-1252</option>
                            </select>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="csvHasHeader" ${analysis.has_header ? 'checked' : ''}>
                            <label class="form-check-label" for="csvHasHeader">
                                File has header row
                            </label>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="fas fa-cut me-2"></i>Column Splitting</h6>
                    </div>
                    <div class="card-body">
                        <div id="columnSplittingOptions">
    `;
    
    if (analysis.nested_columns && Object.keys(analysis.nested_columns).length > 0) {
        html += '<p class="text-muted mb-3">Select columns to split into multiple columns:</p>';
        
        Object.entries(analysis.nested_columns).forEach(([colName, colInfo]) => {
            html += `
                <div class="form-check mb-2">
                    <input class="form-check-input" type="checkbox" id="split_${colName}" value="${colName}" checked>
                    <label class="form-check-label" for="split_${colName}">
                        Split <strong>${colName}</strong> into ${colInfo.estimated_sub_columns} columns
                    </label>
                    <div class="mt-1">
                        <small class="text-muted">Example: ${colInfo.sample_values[0] || 'N/A'}</small>
                    </div>
                </div>
            `;
        });
    } else {
        html += '<p class="text-muted">No nested columns detected.</p>';
    }
    
    html += `
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="mt-3 text-end">
            <button type="button" class="btn btn-success" onclick="previewParsing()">
                <i class="fas fa-eye me-2"></i>Preview Results
            </button>
        </div>
    `;
    
    configContainer.innerHTML = html;
}

function previewParsing() {
    console.log('Starting preview parsing...');
    if (!csvFile) {
        alert('No CSV file selected.');
        return;
    }
    
    console.log('csvAnalysisData:', csvAnalysisData);
    
    // Collect parsing options
    const parsingOptions = {
        delimiter: document.getElementById('csvDelimiter').value,
        has_header: document.getElementById('csvHasHeader').checked,
        encoding: document.getElementById('csvEncoding').value,
        split_columns: {},
        parse_dates: []
    };
    
    console.log('Basic parsing options:', parsingOptions);
    
    // Collect column splitting options
    const splitCheckboxes = document.querySelectorAll('input[id^="split_"]:checked');
    console.log('Found split checkboxes:', splitCheckboxes.length);
    
    splitCheckboxes.forEach(checkbox => {
        const colName = checkbox.value;
        console.log('Processing split column:', colName);
        if (csvAnalysisData && csvAnalysisData.nested_columns) {
            const colInfo = csvAnalysisData.nested_columns[colName];
            if (colInfo) {
                parsingOptions.split_columns[colName] = {
                    separator: colInfo.separator,
                    max_splits: colInfo.estimated_sub_columns
                };
                console.log('Added split config for', colName, ':', parsingOptions.split_columns[colName]);
            } else {
                console.warn('No column info found for:', colName);
            }
        } else {
            console.warn('No csvAnalysisData.nested_columns available');
        }
    });
    
    console.log('Final parsing options:', parsingOptions);
    
    // Show loading
    const previewResults = document.getElementById('previewResults');
    previewResults.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Generating preview...</span>
            </div>
            <p class="mt-2">Generating preview...</p>
        </div>
    `;
    
    // Move to preview step
    showStep(4);
    
    // Create form data
    const formData = new FormData();
    formData.append('csv_file', csvFile);
    formData.append('delimiter', parsingOptions.delimiter);
    formData.append('has_header', parsingOptions.has_header);
    formData.append('encoding', parsingOptions.encoding);
    formData.append('split_columns', JSON.stringify(parsingOptions.split_columns));
    formData.append('parse_dates', JSON.stringify(parsingOptions.parse_dates));
    
    console.log('Sending preview request to /datasets/api/csv/preview/');
    fetch('/datasets/api/csv/preview/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': window.ConvaBI.getCsrfToken()
        },
        body: formData
    })
    .then(response => {
        console.log('Preview response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Preview response data:', data);
        if (data.success) {
            displayUploadPreview(data, parsingOptions);
        } else {
            console.error('Preview failed:', data.error);
            previewResults.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error generating preview: ${data.error || 'Unknown error'}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Preview request failed:', error);
        previewResults.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message}
            </div>
        `;
    });
}

function displayUploadPreview(data, parsingOptions) {
    const previewResults = document.getElementById('previewResults');
    
    let html = `
        <div class="alert alert-success">
            <i class="fas fa-check-circle me-2"></i>
            Preview ready! <strong>${data.total_rows} rows</strong> and <strong>${data.total_columns} columns</strong> will be imported.
        </div>
        
        <div class="card mb-3">
            <div class="card-header">
                <h6><i class="fas fa-table me-2"></i>Data Preview</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive" style="max-height: 300px;">
                    <table class="table table-sm table-striped">
                        <thead class="table-dark">
                            <tr>
                                ${data.column_info.map(col => `<th>${col.name}</th>`).join('')}
                            </tr>
                        </thead>
                        <tbody>
                            ${data.preview_data.slice(0, 10).map(row => `
                                <tr>
                                    ${data.column_info.map(col => `<td>${row[col.name] || ''}</td>`).join('')}
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <div class="d-flex justify-content-between">
            <button type="button" class="btn btn-secondary" onclick="showStep(3)">
                <i class="fas fa-arrow-left me-2"></i>Back to Configuration
            </button>
            <button type="button" class="btn btn-success" onclick="finalizeImport()">
                <i class="fas fa-check me-2"></i>Import Data
            </button>
        </div>
    `;
    
    previewResults.innerHTML = html;
    
    // Store parsing options for final import
    window.finalParsingOptions = parsingOptions;
}

function proceedWithDefaults() {
    // Set default analysis data for cases where analysis failed
    csvAnalysisData = {
        delimiter: ',',
        has_header: true,
        encoding: 'utf-8',
        nested_columns: {},
        parsing_suggestions: []
    };
    
    console.log('Proceeding with default CSV analysis settings');
    
    // Move to configuration step
    showStep(3);
    
    // Setup configuration with defaults
    setupAdvancedConfiguration(csvAnalysisData);
    
    // Ensure Next Step button is visible for step 3
    const nextBtn = document.getElementById('nextStepBtn');
    if (nextBtn) {
        nextBtn.style.display = 'inline-block';
    }
}

function clearCSVFormData() {
    // Clear all form fields
    const csvForm = document.getElementById('csvForm');
    if (csvForm) {
        csvForm.reset();
    }
    
    // Clear specific form elements
    const elements = [
        'csvName', 'csvDescription', 'csvFile',
        'csvDelimiter', 'csvHasHeader', 'csvEncoding'
    ];
    
    elements.forEach(id => {
        const element = document.getElementById(id);
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = element.defaultChecked;
            } else if (element.type === 'file') {
                element.value = '';
            } else {
                element.value = element.defaultValue || '';
            }
        }
    });
    
    // Reset global variables
    currentStep = 1;
    csvAnalysisData = null;
    csvFile = null;
    window.finalParsingOptions = null;
    
    // Clear dynamic content
    const analysisResults = document.getElementById('analysisResults');
    if (analysisResults) {
        analysisResults.innerHTML = '';
    }
    
    const configContent = document.getElementById('advancedConfigContent');
    if (configContent) {
        configContent.innerHTML = '';
    }
    
    const previewResults = document.getElementById('previewResults');
    if (previewResults) {
        previewResults.innerHTML = '';
    }
    
    // Reset to first step
    showStep(1);
    
    // Ensure Next Step button is hidden on step 1
    const nextBtn = document.getElementById('nextStepBtn');
    if (nextBtn) {
        nextBtn.style.display = 'none';
    }
    
    console.log('CSV form data cleared');
}

function finalizeImport() {
    if (!csvFile || !window.finalParsingOptions) {
        alert('Missing file or parsing options.');
        return;
    }
    
    const nameInput = document.getElementById('csvName');
    const descriptionInput = document.getElementById('csvDescription');
    
    if (!nameInput.value.trim()) {
        alert('Please enter a data source name.');
        return;
    }
    
    // Create form data for final import
    const formData = new FormData();
    formData.append('name', nameInput.value.trim());
    formData.append('description', descriptionInput.value.trim());
    formData.append('csv_file', csvFile);
    formData.append('delimiter', window.finalParsingOptions.delimiter);
    formData.append('has_header', window.finalParsingOptions.has_header);
    formData.append('encoding', window.finalParsingOptions.encoding);
    formData.append('split_columns', JSON.stringify(window.finalParsingOptions.split_columns));
    formData.append('parse_dates', JSON.stringify(window.finalParsingOptions.parse_dates));
    
    // Show loading
    const previewResults = document.getElementById('previewResults');
    previewResults.innerHTML = `
        <div class="text-center">
            <div class="spinner-border text-success" role="status">
                <span class="visually-hidden">Importing data...</span>
            </div>
            <p class="mt-2">Importing data...</p>
        </div>
    `;
    
    fetch('/datasets/api/csv/upload-enhanced/', {
        method: 'POST',
        headers: {
            'X-CSRFToken': window.ConvaBI.getCsrfToken()
        },
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            previewResults.innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-check-circle me-2"></i>
                    ${data.message}
                </div>
            `;
            
            // Close modal and redirect
            setTimeout(() => {
                bootstrap.Modal.getInstance(document.getElementById('csvModal')).hide();
                if (data.redirect_url) {
                    window.location.href = data.redirect_url;
                } else {
                    location.reload();
                }
            }, 2000);
        } else {
            previewResults.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    Error importing data: ${data.error || 'Unknown error'}
                </div>
            `;
        }
    })
    .catch(error => {
        previewResults.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                Error: ${error.message}
            </div>
        `;
    });
}
</script>

{% csrf_token %}
{% endblock %} 