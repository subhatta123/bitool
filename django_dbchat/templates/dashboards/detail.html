{% extends 'base.html' %}
{% load static %}

{% block title %}{{ dashboard.name }} - ConvaBI{% endblock %}

{% block extra_css %}
<style>
    /* Edit mode styling */
    .edit-mode .edit-mode-item {
        border: 2px dashed #ffc107;
        transition: all 0.3s ease;
    }
    
    .edit-mode .edit-mode-item:hover {
        border-color: #ff9800;
        box-shadow: 0 4px 8px rgba(255, 193, 7, 0.3);
    }
    
    .edit-mode .btn-group {
        opacity: 1 !important;
    }
    
    /* Hide edit buttons by default */
    .dashboard-item .btn-group {
        opacity: 0;
        transition: opacity 0.3s ease;
    }
    
    .dashboard-item:hover .btn-group {
        opacity: 1;
    }
    
    /* Show edit buttons when in edit mode */
    .dashboard-edit-mode .dashboard-item .btn-group {
        opacity: 1 !important;
    }
    
    /* Edit mode styling */
    .dashboard-edit-mode .dashboard-item {
        border: 2px dashed #007bff;
        position: relative;
        background-color: rgba(0, 123, 255, 0.05);
    }
    
    .dashboard-edit-mode .dashboard-item::before {
        content: "‚úèÔ∏è Edit Mode";
        position: absolute;
        top: -12px;
        right: 15px;
        background: #007bff;
        color: white;
        padding: 2px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: 500;
        z-index: 10;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    /* Toast container positioning */
    .toast-container {
        z-index: 1055;
    }
    
    /* Alert positioning */
    .alert.position-fixed {
        z-index: 1060;
    }
</style>
{% endblock %}

{% block content %}
<!-- CSRF Token for AJAX requests -->
<meta name="csrf-token" content="{{ csrf_token }}">

<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <!-- Dashboard Header -->
            <div class="card mb-4">
                <div class="card-header bg-gradient-primary text-white">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h3 class="mb-0">{{ dashboard.name }}</h3>
                        </div>
                        <div class="btn-group">
                            <a href="{% url 'dashboards:list' %}" class="btn btn-outline-light">
                                <i class="fas fa-arrow-left"></i> Back
                            </a>
                            {% if can_edit %}
                                <button class="btn btn-outline-light" onclick="toggleEditMode()">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <div class="dropdown">
                                    <button class="btn btn-outline-light dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                        <i class="fas fa-cog"></i> More
                                    </button>
                                    <ul class="dropdown-menu dropdown-menu-end" style="position: absolute; z-index: 1050;">
                                        <li><a class="dropdown-item" href="{% url 'dashboards:share' dashboard.id %}"><i class="fas fa-share-alt fa-fw me-2"></i>Share</a></li>
                                        <li><a class="dropdown-item" href="{% url 'dashboards:export' dashboard.id %}"><i class="fas fa-download fa-fw me-2"></i>Export</a></li>
                                        <li><hr class="dropdown-divider"></li>
                                        <li><a class="dropdown-item text-danger" href="#" onclick="deleteDashboard('{{ dashboard.id }}', '{{ dashboard.name }}')"><i class="fas fa-trash fa-fw me-2"></i>Delete Dashboard</a></li>
                                    </ul>
                                </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div class="dashboard-container" id="dashboardContainer">
                {% if dashboard_items %}
                    <div class="row">
                        {% for item in dashboard_items %}
                            <div class="col-md-{{ item.width }} mb-4">
                                <div class="card dashboard-item" data-item-id="{{ item.id }}">
                                    <div class="card-header d-flex justify-content-between align-items-center">
                                        <h5 class="mb-0">{{ item.title }}</h5>
                                        {% if can_edit %}
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-secondary" onclick="editItem('{{ item.id }}')">
                                                    <i class="fas fa-edit"></i>
                                                </button>
                                                <button class="btn btn-outline-danger" onclick="deleteItem('{{ item.id }}')">
                                                    <i class="fas fa-trash"></i>
                                                </button>
                                            </div>
                                        {% endif %}
                                    </div>
                                    <div class="card-body">
                                                                            <div class="dashboard-item-content" id="item-{{ item.id }}">
                                        {% if item.item_type == 'kpi' %}
                                            <div class="text-center">
                                                <h2 class="text-primary" id="kpi-value-{{ item.id }}">--</h2>
                                                <p class="text-muted">{{ item.title }}</p>
                                            </div>
                                        {% elif item.item_type == 'chart' %}
                                            <div id="chart-{{ item.id }}" style="height: 300px;">
                                                <div class="d-flex justify-content-center align-items-center h-100">
                                                    <div class="spinner-border text-primary" role="status">
                                                        <span class="visually-hidden">Loading chart...</span>
                                                    </div>
                                                </div>
                                            </div>
                                        {% elif item.item_type == 'table' %}
                                            <div id="table-{{ item.id }}">
                                                <div class="text-center p-4">
                                                    <i class="fas fa-table fa-3x text-muted mb-2"></i>
                                                    <p class="text-muted">Table will appear here</p>
                                                </div>
                                            </div>
                                        {% else %}
                                            <div class="text-center p-4">
                                                <i class="fas fa-cube fa-3x text-muted mb-2"></i>
                                                <p class="text-muted">{{ item.item_type|title }} content</p>
                                            </div>
                                        {% endif %}
                                    </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <!-- Empty Dashboard -->
                    <div class="text-center py-5">
                        <i class="fas fa-chart-line fa-4x text-muted mb-3"></i>
                        <h4 class="text-muted">Dashboard is Empty</h4>
                        <p class="text-muted">Dashboard items will appear here once you create charts and visualizations through the query interface.</p>
                    </div>
                {% endif %}
            </div>

            <!-- Workflow Navigation -->
            <div class="mt-4 pt-3 border-top">
                <div class="row align-items-center">
                    <div class="col-md-6">
                        <h6 class="text-muted mb-2">
                            <i class="fas fa-route me-2"></i>ConvaBI Workflow Navigation
                        </h6>
                        <small class="text-muted">Continue your data journey</small>
                    </div>
                    <div class="col-md-6">
                        <div class="d-flex justify-content-end gap-2">
                            <a href="{% url 'core:query' %}" class="btn btn-outline-primary btn-sm">
                                <i class="fas fa-arrow-left me-1"></i>Back to Query
                            </a>
                            <a href="{% url 'datasets:list' %}" class="btn btn-outline-secondary btn-sm">
                                <i class="fas fa-database me-1"></i>Data Sources
                            </a>
                            <a href="{% url 'datasets:integration' %}" class="btn btn-outline-warning btn-sm">
                                <i class="fas fa-magic me-1"></i>ETL Operations
                            </a>
                            <a href="{% url 'datasets:semantic' %}" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-brain me-1"></i>Semantic Layer
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<script>
// Basic test to see if JavaScript is working
console.log('üî• JAVASCRIPT IS WORKING');

// Visual debug function (disabled)
function showDebug(message, color = 'red') {
    // Debug messages disabled - charts are working
    // console.log(message);
}

// Dashboard data with error handling
var dashboardData;
try {
    dashboardData = {{ items_json|default:"[]"|safe }};
    console.log('‚úÖ Dashboard data loaded successfully:', dashboardData);
} catch (e) {
    console.error('‚ùå Error parsing dashboard data:', e);
    dashboardData = [];
}

var dashboardId = '{{ dashboard.id }}';
var canEdit = {% if can_edit %}true{% else %}false{% endif %};

console.log('Dashboard ID:', dashboardId);
console.log('Can Edit:', canEdit);

// ENHANCED: Chart loading queue system to prevent simultaneous API calls
var chartLoadingQueue = [];
var isProcessingQueue = false;

// Load Plotly for chart rendering
document.addEventListener('DOMContentLoaded', function() {
    showDebug('DOM Loaded, loading Plotly...', 'blue');
    
    // Try to load Plotly with timeout fallback
    const plotlyScript = document.createElement('script');
    plotlyScript.src = 'https://cdn.plot.ly/plotly-2.35.2.min.js';
    
    let plotlyLoaded = false;
    
    // Set timeout to fall back to tables if Plotly doesn't load in 3 seconds
    const fallbackTimeout = setTimeout(() => {
        if (!plotlyLoaded) {
            showDebug('Plotly timeout, using table fallback', 'orange');
            useFallbackRenderer();
        }
    }, 3000);
    
    plotlyScript.onload = function() {
        plotlyLoaded = true;
        clearTimeout(fallbackTimeout);
        showDebug('Plotly loaded! Rendering charts...', 'green');
        renderDashboardCharts();
    };
    
    plotlyScript.onerror = function() {
        plotlyLoaded = true;
        clearTimeout(fallbackTimeout);
        showDebug('Plotly failed, using table fallback', 'orange');
        useFallbackRenderer();
    };
    
    document.head.appendChild(plotlyScript);
});

function useFallbackRenderer() {
    showDebug('Using fallback chart renderer', 'purple');
    
    // Build queue for fallback rendering
    chartLoadingQueue = dashboardData.filter(item => 
        (item.type === 'chart' || item.type === 'kpi') && item.query && item.data_source
    );
    
    processChartQueue();
}

function renderDashboardCharts() {
    console.log('=== DASHBOARD DEBUG START ===');
    console.log('dashboardData:', dashboardData);
    console.log('dashboardData type:', typeof dashboardData);
    console.log('dashboardData length:', dashboardData ? dashboardData.length : 'undefined');
    
    if (!dashboardData || dashboardData.length === 0) {
        console.log('No dashboard data available');
        return;
    }
    
    // ENHANCED: Build chart loading queue instead of rendering all at once
    chartLoadingQueue = [];
    
    dashboardData.forEach((item, index) => {
        console.log('Processing item ' + index + ':', item);
        console.log('Item type: ' + item.type + ', has chart_config: ' + (!!item.chart_config));
        
        if (item.type === 'chart' || item.type === 'kpi') {
            if (item.query && item.data_source) {
                console.log('Adding to queue:', item.id);
                chartLoadingQueue.push(item);
            } else {
                console.log('Skipping item (no query/data source):', item.id);
                // Render placeholder immediately for items without data
                renderPlaceholderChart(item);
            }
        } else {
            console.log('Skipping item (not chart/kpi):', item.id);
        }
    });
    
    console.log('Chart loading queue built:', chartLoadingQueue.length, 'items');
    console.log('=== DASHBOARD DEBUG END ===');
    
    // Start processing the queue
    processChartQueue();
}

function processChartQueue() {
    if (isProcessingQueue || chartLoadingQueue.length === 0) {
        return;
    }
    
    isProcessingQueue = true;
    console.log('üîÑ Processing chart queue:', chartLoadingQueue.length, 'items remaining');
    
    const currentItem = chartLoadingQueue.shift();
    console.log('üìä Loading chart:', currentItem.id, currentItem.title);
    
    // Load current chart
    if (currentItem.type === 'chart') {
        renderChartQueued(currentItem);
    } else if (currentItem.type === 'kpi') {
        renderKPIQueued(currentItem);
    }
}

function renderChartQueued(item) {
    const containerId = 'chart-' + item.id;
    const container = document.getElementById(containerId);
    
    if (!container) {
        console.error('Chart container not found:', containerId);
        onChartLoadComplete();
        return;
    }
    
    // Show loading state
    container.innerHTML = `
        <div class="d-flex justify-content-center align-items-center h-100">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading chart...</span>
            </div>
        </div>
    `;
    
    // Execute query with completion callback
    executeQueryForChartQueued(item);
}

function renderKPIQueued(item) {
    const containerId = 'kpi-value-' + item.id;
    const container = document.getElementById(containerId);
    
    if (!container) {
        console.error('KPI container not found:', containerId);
        onChartLoadComplete();
        return;
    }
    
    // Show loading state
    container.textContent = '...';
    container.classList.add('text-muted');
    
    // Execute query with completion callback
    executeQueryForKPIQueued(item);
}

function executeQueryForChartQueued(item) {
    // Get CSRF token with fallback
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    // Add timeout to prevent hanging
    const timeoutId = setTimeout(() => {
        console.warn('‚è∞ Chart query timeout for:', item.id);
        renderPlaceholderChart(item);
        onChartLoadComplete();
    }, 10000); // 10 second timeout
    
    // Execute SQL query via API
    fetch('/api/execute-dashboard-query/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            query: item.query,
            data_source_id: item.data_source
        })
    })
    .then(response => response.json())
    .then(data => {
        clearTimeout(timeoutId);
        
        if (data.success && data.result_data && data.result_data.length > 0) {
            console.log('‚úÖ Query successful for:', item.id);
            renderChartWithData(item, data.result_data);
        } else {
            console.warn('‚ö†Ô∏è No data for:', item.id);
            renderPlaceholderChart(item);
        }
        
        onChartLoadComplete();
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('‚ùå Query failed for:', item.id, error);
        renderPlaceholderChart(item);
        onChartLoadComplete();
    });
}

function executeQueryForKPIQueued(item) {
    // Get CSRF token with fallback
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    // Add timeout to prevent hanging
    const timeoutId = setTimeout(() => {
        console.warn('‚è∞ KPI query timeout for:', item.id);
        renderPlaceholderKPI(item);
        onChartLoadComplete();
    }, 10000); // 10 second timeout
    
    // Execute SQL query via API
    fetch('/api/execute-dashboard-query/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            query: item.query,
            data_source_id: item.data_source
        })
    })
    .then(response => response.json())
    .then(data => {
        clearTimeout(timeoutId);
        
        if (data.success && data.result_data && data.result_data.length > 0) {
            console.log('‚úÖ KPI query successful for:', item.id);
            const record = data.result_data[0];
            const columns = Object.keys(record);
            const value = record[columns[0]]; // Use first column value
            renderKPIValue(item.id, value);
        } else {
            console.warn('‚ö†Ô∏è No data for KPI:', item.id);
            renderPlaceholderKPI(item);
        }
        
        onChartLoadComplete();
    })
    .catch(error => {
        clearTimeout(timeoutId);
        console.error('‚ùå KPI query failed for:', item.id, error);
        renderPlaceholderKPI(item);
        onChartLoadComplete();
    });
}

function onChartLoadComplete() {
    isProcessingQueue = false;
    
    // Process next item in queue with a small delay to prevent overload
    setTimeout(() => {
        if (chartLoadingQueue.length > 0) {
            processChartQueue();
        } else {
            console.log('üéâ All charts loaded successfully!');
        }
    }, 200); // 200ms delay between chart loads
}

function renderPlaceholderChart(item) {
    const containerId = 'chart-' + item.id;
    const container = document.getElementById(containerId);
    
    if (!container) return;
    
    container.innerHTML = `
        <div class="text-center p-4">
            <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
            <p class="text-muted">No Data Available</p>
            <small class="text-muted">${item.title}</small>
        </div>
    `;
}

function renderPlaceholderKPI(item) {
    const containerId = 'kpi-value-' + item.id;
    const container = document.getElementById(containerId);
    
    if (!container) return;
    
    container.textContent = 'No Data';
    container.classList.remove('text-muted');
    container.classList.add('text-warning');
}

function renderChart(item) {
    const containerId = 'chart-' + item.id;
    const container = document.getElementById(containerId);
    
    if (!container) {
        console.error('Chart container not found:', containerId);
        return;
    }
    
    try {
        const config = item.chart_config || {};
        
        // DEBUG: Log what we're dealing with
        console.log('=== CHART DEBUG ===');
        console.log('Item:', item);
        console.log('Config:', config);
        console.log('Chart type:', config.chart_type);
        console.log('Has query:', !!item.query);
        console.log('Has data_source:', !!item.data_source);
        
        // ENHANCED: Check for gauge/indicator charts OR single-value data
        const isGaugeChart = config && (config.chart_type === 'gauge' || config.chart_type === 'indicator');
        const hasGaugeData = config && config.data && config.data[0] && 
                           (config.data[0].type === 'indicator' || config.data[0].type === 'gauge');
        
        if (isGaugeChart || hasGaugeData) {
            console.log('*** DETECTED GAUGE CHART - CONVERTING TO KPI ***');
            container.innerHTML = '<div class="text-center p-4 text-info">Converting gauge to number...</div>';
            
            if (item.query && item.data_source) {
                executeQueryForKPI(item, true); // true = use chart container
            } else {
                container.innerHTML = '<div class="text-center p-4 text-muted">No Data</div>';
            }
            return;
        }
        
        console.log('Regular chart - proceeding with normal rendering');
        
        // Execute the stored SQL query to get real data for regular charts
        if (item.query && item.data_source) {
            executeQueryForChart(item);
        } else {
            console.warn('No query or data source found for item:', item.id);
            // FIXED: Show a proper fallback message
            var queryStatus = item.query ? 'Available' : 'Missing';
            var dataSourceStatus = item.data_source ? 'Available' : 'Missing';
            container.innerHTML = '<div class="text-center p-4">' +
                '<i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>' +
                '<p class="text-muted">Chart configuration incomplete</p>' +
                '<small class="text-muted">Query: ' + queryStatus + ' | Data Source: ' + dataSourceStatus + '</small>' +
                '</div>';
        }
        
    } catch (error) {
        console.error('Error rendering chart:', error);
        container.innerHTML = '<div class="text-center p-4">' +
            '<i class="fas fa-exclamation-triangle fa-2x text-warning mb-2"></i>' +
            '<p class="text-muted">Error loading chart</p>' +
            '<small class="text-muted">' + error.message + '</small>' +
            '</div>';
    }
}

function executeQueryForChart(item) {
    const containerId = `chart-${item.id}`;
    const container = document.getElementById(containerId);
    
    // Show loading state
    container.innerHTML = `
        <div class="d-flex justify-content-center align-items-center h-100">
            <div class="spinner-border text-primary" role="status">
                <span class="visually-hidden">Loading chart data...</span>
            </div>
        </div>
    `;
    
    // Get CSRF token with fallback
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    // Execute SQL query via API
    fetch('/api/execute-dashboard-query/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            query: item.query,
            data_source_id: item.data_source
        })
    })
    .then(response => response.json())
    .then(data => {
        showDebug('API Response: ' + (data.success ? 'SUCCESS' : 'FAILED'), data.success ? 'blue' : 'red');
        if (data.success && data.result_data && data.result_data.length > 0) {
            showDebug('Calling renderChartWithData with ' + data.result_data.length + ' rows', 'orange');
            renderChartWithData(item, data.result_data);
        } else {
            showDebug('No data returned', 'red');
            renderDefaultChart(item);
        }
    })
    .catch(error => {
        console.error('Error executing query for chart:', error);
        renderDefaultChart(item);
    });
}

function renderChartWithData(item, resultData) {
    const containerId = `chart-${item.id}`;
    const config = item.chart_config;
    
    showDebug('renderChartWithData called', 'purple');
    
    try {
        // Extract data from query results
        const records = Array.isArray(resultData) ? resultData : [];
        console.log('Records array:', records);
        if (records.length === 0) {
            console.log('No records found, rendering default chart');
            renderDefaultChart(item);
            return;
        }
        
        const firstRecord = records[0];
        const columns = Object.keys(firstRecord);
        
        let data, layout;
        
        // ENHANCED: Check if this is single-value data (should be KPI)
        // This catches ALL single-value queries regardless of chart type
        if (columns.length === 1 && records.length === 1) {
            // Single value = render as large number instead of chart
            console.log('üî• DETECTED SINGLE VALUE - FORCING KPI DISPLAY');
            console.log('Value:', records[0][columns[0]]);
            const value = records[0][columns[0]];
            renderKPIInChartContainer(containerId, value, item.title);
            return;
        }
        
        // ALSO check for typical KPI column names
        if (columns.length === 1 && (
            columns[0].toLowerCase().includes('total') ||
            columns[0].toLowerCase().includes('sum') ||
            columns[0].toLowerCase().includes('count') ||
            columns[0].toLowerCase().includes('avg') ||
            columns[0].toLowerCase().includes('average')
        )) {
            console.log('üî• DETECTED KPI COLUMN NAME - FORCING KPI DISPLAY');
            const value = records[0][columns[0]];
            renderKPIInChartContainer(containerId, value, item.title);
            return;
        }
        
        // Determine chart data based on results
        if (columns.length >= 2) {
            const xColumn = config.x_column || columns[0];
            const yColumn = config.y_column || columns[1];
            
            const xData = records.map(r => r[xColumn]);
            const yData = records.map(r => r[yColumn]);
            
            switch (config.chart_type) {
                case 'bar':
                    data = [{
                        x: xData,
                        y: yData,
                        type: 'bar',
                        marker: { color: '#007bff' }
                    }];
                    break;
                    
                case 'line':
                    data = [{
                        x: xData,
                        y: yData,
                        type: 'scatter',
                        mode: 'lines+markers',
                        line: { color: '#007bff' }
                    }];
                    break;
                    
                case 'pie':
                    data = [{
                        labels: xData,
                        values: yData,
                        type: 'pie'
                    }];
                    break;
                    
                default:
                    data = [{
                        x: xData,
                        y: yData,
                        type: 'bar',
                        marker: { color: '#007bff' }
                    }];
            }
        } else if (columns.length === 1) {
            // Single value - render as KPI
            const value = records[0][columns[0]];
            renderKPIValue(item.id, value);
            return;
        }
        
        layout = {
            title: {
                text: config.title || item.title,
                font: { size: 14 }
            },
            margin: { l: 40, r: 40, t: 40, b: 40 },
            plot_bgcolor: 'white',
            paper_bgcolor: 'white'
        };
        
        showDebug('About to render Plotly chart', 'cyan');
        
        // Check if Plotly is loaded
        if (typeof Plotly === 'undefined') {
            showDebug('Plotly not loaded, waiting...', 'yellow');
            setTimeout(() => renderChartWithData(item, resultData), 500);
            return;
        }
        
        showDebug('Plotly available, rendering now', 'lime');
        
        // Clear any loading spinner first
        const container = document.getElementById(containerId);
        if (container) {
            container.innerHTML = ''; // Clear loading spinner
        }
        
        Plotly.newPlot(containerId, data, layout, {
            responsive: true,
            displayModeBar: false
        });
        showDebug('Plotly chart rendered successfully!', 'green');
        
    } catch (error) {
        console.error('Error rendering chart with data:', error);
        renderDefaultChart(item);
    }
}

function renderDefaultChart(item) {
    const containerId = `chart-${item.id}`;
    const config = item.chart_config;
    
    // Clear any loading spinner first
    const container = document.getElementById(containerId);
    if (container) {
        container.innerHTML = ''; // Clear loading spinner
    }
    
    // Fallback to sample data if real data unavailable
    let data;
    
    switch (config.chart_type) {
        case 'bar':
            data = [{
                x: ['No Data'],
                y: [0],
                type: 'bar',
                marker: { color: '#6c757d' }
            }];
            break;
            
        case 'line':
            data = [{
                x: ['No Data'],
                y: [0],
                type: 'scatter',
                mode: 'lines+markers',
                line: { color: '#6c757d' }
            }];
            break;
            
        case 'pie':
            data = [{
                labels: ['No Data'],
                values: [1],
                type: 'pie'
            }];
            break;
            
        default:
            data = [{
                x: ['No Data'],
                y: [0],
                type: 'bar',
                marker: { color: '#6c757d' }
            }];
    }
    
    const layout = {
        title: {
            text: config.title || item.title,
            font: { size: 14 }
        },
        margin: { l: 40, r: 40, t: 40, b: 40 },
        plot_bgcolor: 'white',
        paper_bgcolor: 'white'
    };
    
    Plotly.newPlot(containerId, data, layout, {
        responsive: true,
        displayModeBar: false
    });
}

function renderKPIValue(itemId, value) {
    const containerId = `kpi-value-${itemId}`;
    const container = document.getElementById(containerId);
    
    if (container) {
        // Clear any loading state
        container.classList.remove('text-muted');
        
        const numericValue = parseFloat(value);
        if (!isNaN(numericValue)) {
            // Format large numbers nicely
            let formattedValue;
            if (numericValue >= 1000000) {
                formattedValue = (numericValue / 1000000).toFixed(1) + 'M';
            } else if (numericValue >= 1000) {
                formattedValue = (numericValue / 1000).toFixed(1) + 'K';
            } else {
                formattedValue = numericValue.toLocaleString(undefined, { maximumFractionDigits: 0 });
            }
            
            container.textContent = formattedValue;
            container.classList.add('text-success');
            
            // Make KPI value large and prominent
            container.style.fontSize = '2.5rem';
            container.style.fontWeight = 'bold';
            container.style.textAlign = 'center';
            container.style.padding = '20px';
        } else {
            container.textContent = value;
            container.classList.add('text-primary');
            container.style.fontSize = '1.5rem';
            container.style.fontWeight = 'bold';
            container.style.textAlign = 'center';
        }
    }
}

function renderKPIInChartContainer(containerId, value, title) {
    const container = document.getElementById(containerId);
    if (!container) return;
    
    const numericValue = parseFloat(value);
    let formattedValue;
    
    if (!isNaN(numericValue)) {
        // Format large numbers nicely
        if (numericValue >= 1000000) {
            formattedValue = (numericValue / 1000000).toFixed(1) + 'M';
        } else if (numericValue >= 1000) {
            formattedValue = (numericValue / 1000).toFixed(1) + 'K';
        } else {
            formattedValue = numericValue.toLocaleString(undefined, { maximumFractionDigits: 0 });
        }
    } else {
        formattedValue = value;
    }
    
    // Create a centered KPI display
    container.innerHTML = `
        <div class="d-flex flex-column justify-content-center align-items-center h-100 p-4">
            <div style="font-size: 3rem; font-weight: bold; color: #28a745; text-align: center;">
                ${formattedValue}
            </div>
            <div style="font-size: 1rem; color: #6c757d; text-align: center; margin-top: 10px;">
                ${title || 'Total'}
            </div>
        </div>
    `;
}

function executeQueryForKPI(item, useChartContainer = false) {
    // Determine which container to use
    const containerId = useChartContainer ? 'chart-' + item.id : 'kpi-value-' + item.id;
    const container = document.getElementById(containerId);
    
    if (!container) {
        console.error('KPI container not found:', containerId);
        return;
    }
    
    // Show loading state
    if (useChartContainer) {
        container.innerHTML = '<div class="d-flex justify-content-center align-items-center h-100"><div class="text-muted">Loading...</div></div>';
    } else {
        container.textContent = '...';
        container.classList.add('text-muted');
    }
    
    // Get CSRF token with fallback
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    // Execute SQL query via API
    fetch('/api/execute-dashboard-query/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify({
            query: item.query,
            data_source_id: item.data_source
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success && data.result_data && data.result_data.length > 0) {
            const record = data.result_data[0];
            const columns = Object.keys(record);
            const value = record[columns[0]]; // Use first column value
            
            if (useChartContainer) {
                renderKPIInChartContainer(containerId, value, item.title);
            } else {
                renderKPIValue(item.id, value);
            }
        } else {
            console.error('No data returned for KPI:', data);
            if (useChartContainer) {
                container.innerHTML = '<div class="text-center p-4 text-warning">No Data</div>';
            } else {
                container.textContent = 'No Data';
                container.classList.remove('text-muted');
                container.classList.add('text-warning');
            }
        }
    })
    .catch(error => {
        console.error('Error executing query for KPI:', error);
        if (useChartContainer) {
            container.innerHTML = '<div class="text-center p-4 text-danger">Error</div>';
        } else {
            container.textContent = 'Error';
            container.classList.remove('text-muted');
            container.classList.add('text-danger');
        }
    });
}

function renderKPI(item) {
    // Force KPI to always execute fresh query for simple number display
    if (item.query && item.data_source) {
        executeQueryForKPI(item);
    } else {
        // Fallback for missing query
        const containerId = 'kpi-value-' + item.id;
        const container = document.getElementById(containerId);
        if (container) {
            container.textContent = 'No Data';
            container.classList.add('text-muted');
        }
    }
}

// Delete dashboard function
function deleteDashboard(dashboardId, dashboardName) {
    if (confirm('Are you sure you want to delete the dashboard "' + dashboardName + '"? This action cannot be undone.')) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        
        // Send DELETE request to the delete URL
        fetch('/dashboards/' + dashboardId + '/delete/', {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': csrfToken,
                'Content-Type': 'application/json'
            }
        })
        .then(response => {
            if (response.ok) {
                return response.json().catch(() => ({ success: true, message: 'Dashboard deleted successfully' }));
            } else {
                throw new Error('HTTP ' + response.status + ' - Failed to delete dashboard');
            }
        })
        .then(result => {
            if (result.success) {
                // Redirect to dashboard list after successful deletion
                window.location.href = '/dashboards/';
            } else {
                alert('Error: ' + (result.error || 'Failed to delete dashboard'));
            }
        })
        .catch(error => {
            console.error('Delete error:', error);
            alert('Failed to delete dashboard: ' + error.message);
        });
    }
}

// Toggle edit mode for dashboard
function toggleEditMode() {
    const editButtons = document.querySelectorAll('.btn-group.btn-group-sm');
    const isEditMode = document.querySelector('.dashboard-edit-mode') !== null;
    
    if (isEditMode) {
        // Exit edit mode
        document.body.classList.remove('dashboard-edit-mode');
        editButtons.forEach(btnGroup => {
            btnGroup.style.display = 'none';
        });
        
        // Change button text
        const toggleBtn = document.querySelector('button[onclick="toggleEditMode()"]');
        if (toggleBtn) {
            toggleBtn.innerHTML = '<i class="fas fa-edit"></i> Edit';
        }
    } else {
        // Enter edit mode
        document.body.classList.add('dashboard-edit-mode');
        editButtons.forEach(btnGroup => {
            btnGroup.style.display = 'flex';
        });
        
        // Change button text
        const toggleBtn = document.querySelector('button[onclick="toggleEditMode()"]');
        if (toggleBtn) {
            toggleBtn.innerHTML = '<i class="fas fa-times"></i> Done';
        }
    }
}

// Edit dashboard item
function editItem(itemId) {
    console.log('Edit item requested for ID:', itemId);
    
    // Find the item in dashboardData
    const item = dashboardData.find(d => d.id === itemId);
    if (!item) {
        console.error('Item not found:', itemId);
        alert('Item not found');
        return;
    }
    
    // Create edit modal
    const modalHtml = `
        <div class="modal fade" id="editItemModal" tabindex="-1">
            <div class="modal-dialog">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Edit Dashboard Item</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <div class="modal-body">
                        <form id="editItemForm">
                            <div class="mb-3">
                                <label for="itemTitle" class="form-label">Title</label>
                                <input type="text" class="form-control" id="itemTitle" value="${item.title}" required>
                            </div>
                            <div class="mb-3">
                                <label for="itemWidth" class="form-label">Width (1-12)</label>
                                <input type="number" class="form-control" id="itemWidth" value="${item.width}" min="1" max="12" required>
                            </div>
                            <div class="mb-3">
                                <label for="itemHeight" class="form-label">Height</label>
                                <input type="number" class="form-control" id="itemHeight" value="${item.height}" min="1" max="12" required>
                            </div>
                            ${item.type === 'chart' ? `
                            <div class="mb-3">
                                <label for="chartType" class="form-label">Chart Type</label>
                                <select class="form-select" id="chartType">
                                    <option value="bar" ${item.chart_config?.chart_type === 'bar' ? 'selected' : ''}>Bar Chart</option>
                                    <option value="line" ${item.chart_config?.chart_type === 'line' ? 'selected' : ''}>Line Chart</option>
                                    <option value="pie" ${item.chart_config?.chart_type === 'pie' ? 'selected' : ''}>Pie Chart</option>
                                    <option value="scatter" ${item.chart_config?.chart_type === 'scatter' ? 'selected' : ''}>Scatter Plot</option>
                                </select>
                            </div>
                            ` : ''}
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="button" class="btn btn-primary" onclick="saveItemEdit('${itemId}')">Save Changes</button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    // Remove existing modal if any
    const existingModal = document.getElementById('editItemModal');
    if (existingModal) {
        existingModal.remove();
    }
    
    // Add modal to DOM
    document.body.insertAdjacentHTML('beforeend', modalHtml);
    
    // Show modal
    const modal = new bootstrap.Modal(document.getElementById('editItemModal'));
    modal.show();
}

// Save item edit
function saveItemEdit(itemId) {
    const title = document.getElementById('itemTitle').value;
    const width = parseInt(document.getElementById('itemWidth').value);
    const height = parseInt(document.getElementById('itemHeight').value);
    const chartType = document.getElementById('chartType')?.value;
    
    if (!title || !width || !height) {
        alert('Please fill in all required fields');
        return;
    }
    
    // Get CSRF token
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
    
    // Prepare update data
    const updateData = {
        action: 'update',
        item_id: itemId,
        title: title,
        width: width,
        height: height
    };
    
    // Add chart config if it's a chart item
    if (chartType) {
        updateData.chart_config = {
            chart_type: chartType
        };
    }
    
    // Send update request
    fetch('/dashboards/' + dashboardId + '/items/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': csrfToken
        },
        body: JSON.stringify(updateData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal
            const modal = bootstrap.Modal.getInstance(document.getElementById('editItemModal'));
            modal.hide();
            
            // Reload page to show changes
            location.reload();
        } else {
            alert('Error updating item: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        console.error('Error updating item:', error);
        alert('Failed to update item: ' + error.message);
    });
}

// Delete dashboard item
function deleteItem(itemId) {
    // Find the item in dashboardData to get its title
    const item = dashboardData.find(d => d.id === itemId);
    const itemTitle = item ? item.title : 'this item';
    
    if (confirm('Are you sure you want to delete "' + itemTitle + '"? This action cannot be undone.')) {
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
        
        // Send delete request
        fetch('/dashboards/' + dashboardId + '/items/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({
                action: 'delete',
                item_id: itemId
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Remove item from DOM
                const itemElement = document.querySelector(`[data-item-id="${itemId}"]`);
                if (itemElement) {
                    itemElement.closest('.col-md-' + (item?.width || 6)).remove();
                }
                
                // Show success message
                const alert = document.createElement('div');
                alert.className = 'alert alert-success alert-dismissible fade show';
                alert.innerHTML = `
                    <strong>Success!</strong> Item "${itemTitle}" has been deleted.
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                const container = document.querySelector('.container-fluid');
                if (container) {
                    container.insertBefore(alert, container.firstChild);
                    
                    // Auto-dismiss after 3 seconds
                    setTimeout(() => {
                        alert.remove();
                    }, 3000);
                }
                
                // Update dashboardData
                const index = dashboardData.findIndex(d => d.id === itemId);
                if (index > -1) {
                    dashboardData.splice(index, 1);
                }
                
                // Check if dashboard is now empty
                if (dashboardData.length === 0) {
                    location.reload(); // Reload to show empty state
                }
            } else {
                alert('Error deleting item: ' + (data.error || 'Unknown error'));
            }
        })
        .catch(error => {
            console.error('Error deleting item:', error);
            alert('Failed to delete item: ' + error.message);
        });
    }
}
</script>

{% endblock %}