{% extends 'base.html' %}

{% block title %}LLM Configuration - ConvaBI{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient-primary text-white">
                    <h3 class="mb-0">
                        <i class="fas fa-robot me-2"></i>
                        LLM Configuration
                    </h3>
                    <p class="mb-0">Configure AI models for natural language to SQL translation</p>
                </div>
                <div class="card-body">
                    <!-- Provider Selection -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <h5>Choose Your AI Provider</h5>
                            <p class="text-muted">Select the AI provider you want to use for natural language queries</p>
                            
                            <div class="row">
                                <!-- OpenAI Option -->
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100 border-primary provider-card" 
                                         onclick="selectProvider('openai')" 
                                         id="openai-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-brain fa-3x text-primary mb-3"></i>
                                            <h5 class="card-title">OpenAI</h5>
                                            <p class="card-text">GPT-4 and GPT-3.5 models with excellent SQL generation capabilities</p>
                                            <ul class="list-unstyled text-start">
                                                <li><i class="fas fa-check text-success"></i> High accuracy</li>
                                                <li><i class="fas fa-check text-success"></i> Advanced reasoning</li>
                                                <li><i class="fas fa-check text-success"></i> Multiple model options</li>
                                                <li><i class="fas fa-times text-warning"></i> Requires API key (paid)</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>

                                <!-- Ollama Option -->
                                <div class="col-md-6 mb-3">
                                    <div class="card h-100 border-success provider-card" 
                                         onclick="selectProvider('ollama')" 
                                         id="ollama-card">
                                        <div class="card-body text-center">
                                            <i class="fas fa-server fa-3x text-success mb-3"></i>
                                            <h5 class="card-title">Ollama (Local)</h5>
                                            <p class="card-text">SQLCoder and other local models for on-premise deployment</p>
                                            <ul class="list-unstyled text-start">
                                                <li><i class="fas fa-check text-success"></i> Free to use</li>
                                                <li><i class="fas fa-check text-success"></i> Privacy & security</li>
                                                <li><i class="fas fa-check text-success"></i> No API limits</li>
                                                <li><i class="fas fa-times text-warning"></i> Requires local setup</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Configuration Forms -->
                    <div id="provider-config">
                        <!-- OpenAI Configuration -->
                        <div id="openai-config" class="provider-config-section" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-brain text-primary"></i> OpenAI Configuration
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <form id="openai-form">
                                        <div class="mb-3">
                                            <label for="openai-api-key" class="form-label">OpenAI API Key *</label>
                                            <div class="input-group">
                                                <input type="password" class="form-control" id="openai-api-key" 
                                                       placeholder="sk-..." required>
                                                <button class="btn btn-outline-secondary" type="button" 
                                                        onclick="togglePasswordVisibility('openai-api-key', this)">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                            </div>
                                            <div class="form-text">
                                                Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank">OpenAI Platform</a>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="openai-model" class="form-label">Model</label>
                                                    <select class="form-select" id="openai-model">
                                                        <option value="gpt-4-turbo-preview">GPT-4 Turbo (Recommended)</option>
                                                        <option value="gpt-4">GPT-4</option>
                                                        <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                                                    </select>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="openai-temperature" class="form-label">Temperature</label>
                                                    <input type="range" class="form-range" id="openai-temperature" 
                                                           min="0" max="1" step="0.1" value="0.1">
                                                    <div class="d-flex justify-content-between">
                                                        <small>0 (Precise)</small>
                                                        <small id="temp-value">0.1</small>
                                                        <small>1 (Creative)</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="openai-max-tokens" class="form-label">Max Tokens</label>
                                                    <input type="number" class="form-control" id="openai-max-tokens" 
                                                           value="2000" min="100" max="4000">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="openai-timeout" class="form-label">Timeout (seconds)</label>
                                                    <input type="number" class="form-control" id="openai-timeout" 
                                                           value="30" min="10" max="120">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-between">
                                            <button type="button" class="btn btn-outline-primary" onclick="testOpenAIConnection(this)">
                                                <i class="fas fa-plug"></i> Test Connection
                                            </button>
                                            <button type="submit" class="btn btn-primary">
                                                <i class="fas fa-save"></i> Save Configuration
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>

                        <!-- Ollama Configuration -->
                        <div id="ollama-config" class="provider-config-section" style="display: none;">
                            <div class="card">
                                <div class="card-header">
                                    <h5 class="mb-0">
                                        <i class="fas fa-server text-success"></i> Ollama Configuration
                                    </h5>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-info">
                                        <h6><i class="fas fa-info-circle"></i> Setup Instructions</h6>
                                        <ol class="mb-0">
                                            <li>Install Ollama from <a href="https://ollama.ai" target="_blank">ollama.ai</a></li>
                                            <li>Run: <code>ollama pull sqlcoder:15b</code> or <code>ollama pull codellama:13b</code></li>
                                            <li>Start the Ollama service</li>
                                            <li>Configure the connection below</li>
                                        </ol>
                                    </div>

                                    <form id="ollama-form">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <div class="mb-3">
                                                    <label for="ollama-url" class="form-label">Ollama Server URL</label>
                                                    <input type="url" class="form-control" id="ollama-url" 
                                                           value="http://localhost:11434" required>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="mb-3">
                                                    <label for="ollama-timeout" class="form-label">Timeout (seconds)</label>
                                                    <input type="number" class="form-control" id="ollama-timeout" 
                                                           value="60" min="30" max="300">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="mb-3">
                                            <label for="ollama-model" class="form-label">Model</label>
                                            <div class="input-group">
                                                <select class="form-select" id="ollama-model">
                                                    <option value="sqlcoder:15b">SQLCoder 15B (Recommended for SQL)</option>
                                                    <option value="sqlcoder:7b">SQLCoder 7B (Faster)</option>
                                                    <option value="codellama:13b">CodeLlama 13B</option>
                                                    <option value="codellama:7b">CodeLlama 7B</option>
                                                    <option value="custom">Custom Model</option>
                                                </select>
                                                <button class="btn btn-outline-secondary" type="button" onclick="refreshOllamaModels(this)">
                                                    <i class="fas fa-sync"></i>
                                                </button>
                                            </div>
                                        </div>

                                        <div id="custom-model-input" style="display: none;">
                                            <div class="mb-3">
                                                <label for="ollama-custom-model" class="form-label">Custom Model Name</label>
                                                <input type="text" class="form-control" id="ollama-custom-model" 
                                                       placeholder="model:tag">
                                            </div>
                                        </div>

                                        <div class="row">
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="ollama-temperature" class="form-label">Temperature</label>
                                                    <input type="range" class="form-range" id="ollama-temperature" 
                                                           min="0" max="1" step="0.1" value="0.1">
                                                    <div class="d-flex justify-content-between">
                                                        <small>0 (Precise)</small>
                                                        <small id="ollama-temp-value">0.1</small>
                                                        <small>1 (Creative)</small>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <div class="mb-3">
                                                    <label for="ollama-top-p" class="form-label">Top P</label>
                                                    <input type="range" class="form-range" id="ollama-top-p" 
                                                           min="0" max="1" step="0.1" value="0.9">
                                                    <div class="d-flex justify-content-between">
                                                        <small>0</small>
                                                        <small id="ollama-top-p-value">0.9</small>
                                                        <small>1</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>

                                        <div class="d-flex justify-content-between">
                                            <button type="button" class="btn btn-outline-success" onclick="testOllamaConnection(this)">
                                                <i class="fas fa-plug"></i> Test Connection
                                            </button>
                                            <button type="submit" class="btn btn-success">
                                                <i class="fas fa-save"></i> Save Configuration
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Current Status -->
                    <div class="mt-4 pt-3 border-top">
                        <h5>Current Configuration</h5>
                        <div id="current-status" class="alert alert-secondary">
                            <i class="fas fa-info-circle"></i> No LLM provider configured yet. Please select and configure a provider above.
                        </div>
                    </div>

                    <!-- Navigation -->
                    <div class="mt-3">
                        <a href="{% url 'core:home' %}" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left"></i> Back to Home
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% csrf_token %}
<meta name="csrf-token" content="{{ csrf_token }}">

<!-- Loading Modal -->
<div class="modal fade" id="loadingModal" tabindex="-1" aria-labelledby="loadingModalLabel" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-body text-center py-4">
                <div class="spinner-border text-primary mb-3" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <h5 id="loadingModalMessage">Processing...</h5>
                <p class="text-muted mb-0" id="loadingModalSubtext">Please wait while we process your request.</p>
            </div>
        </div>
    </div>
</div>

<script>
let selectedProvider = null;

function selectProvider(provider) {
    selectedProvider = provider;
    
    // Update card selection
    document.querySelectorAll('.provider-card').forEach(card => {
        card.classList.remove('border-primary', 'bg-light');
    });
    
    document.getElementById(`${provider}-card`).classList.add('border-primary', 'bg-light');
    
    // Show configuration form
    document.querySelectorAll('.provider-config-section').forEach(section => {
        section.style.display = 'none';
    });
    
    document.getElementById(`${provider}-config`).style.display = 'block';
}

function togglePasswordVisibility(inputId, buttonElement) {
    const input = document.getElementById(inputId);
    const icon = buttonElement.querySelector('i');
    
    if (input.type === 'password') {
        input.type = 'text';
        icon.className = 'fas fa-eye-slash';
    } else {
        input.type = 'password';
        icon.className = 'fas fa-eye';
    }
}

function testOpenAIConnection(buttonElement) {
    const apiKey = document.getElementById('openai-api-key').value;
    const model = document.getElementById('openai-model').value;
    
    if (!apiKey) {
        showAlert('Please enter your OpenAI API key first', 'warning');
        return;
    }
    
    // Show loading
    const btn = buttonElement;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    btn.disabled = true;
    
    // Call backend API
    fetch('/llm-config/test-openai/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            api_key: apiKey,
            model: model
        })
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        if (data.success) {
            showAlert(data.message, 'success');
            updateCurrentStatus('OpenAI', data.model_info);
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        console.error('Error:', error);
        showAlert('❌ Connection test failed: ' + error.message, 'danger');
    });
}

function testOllamaConnection(buttonElement) {
    console.log('Testing Ollama connection...');
    const serverUrl = document.getElementById('ollama-url').value;
    const model = document.getElementById('ollama-model').value === 'custom' 
        ? document.getElementById('ollama-custom-model').value 
        : document.getElementById('ollama-model').value;
    const timeout = document.getElementById('ollama-timeout').value;
    
    console.log('Server URL:', serverUrl);
    console.log('Model:', model);
    
    if (!serverUrl) {
        showAlert('Please enter the Ollama server URL first', 'warning');
        return;
    }
    
    if (!model || model === 'custom') {
        showAlert('Please select or enter a model name', 'warning');
        return;
    }
    
    // Show loading on button instead of modal for better UX
    const btn = buttonElement;
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
    btn.disabled = true;
    
    console.log('Sending test request...');
    
    // Call backend API
    fetch('/llm-config/test-ollama/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            server_url: serverUrl,
            model: model,
            timeout: parseInt(timeout)
        })
    })
    .then(response => {
        console.log('Response status:', response.status);
        return response.json();
    })
    .then(data => {
        console.log('Response data:', data);
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        if (data.success) {
            const message = String(data.message || 'Connection successful');
            console.log('Test success message type:', typeof message, 'value:', message);
            showAlert(message, 'success');
            alert('TEST SUCCESS: ' + message); // Temporary debugging alert
            
            if (data.model_info) {
                updateCurrentStatus('Ollama', data.model_info);
            } else {
                console.warn('No model_info in response');
                updateCurrentStatus('Ollama', { model: model, status: 'Active' });
            }
        } else {
            const message = String(data.message || 'Connection failed');
            console.log('Test error message type:', typeof message, 'value:', message);
            showAlert(message, 'danger');
            alert('TEST ERROR: ' + message); // Temporary debugging alert
            
            if (data.available_models) {
                showAlert('Available models: ' + data.available_models.join(', '), 'info');
            }
        }
    })
    .catch(error => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        console.error('Error:', error);
        showAlert('Connection test failed: ' + (error.message || 'Unknown error'), 'danger');
    });
}

function refreshOllamaModels(buttonElement) {
    const serverUrl = document.getElementById('ollama-url').value;
    
    if (!serverUrl) {
        showAlert('Please enter the Ollama server URL first', 'warning');
        return;
    }
    
    const btn = buttonElement;
    const originalHTML = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
    btn.disabled = true;
    
    // Call backend API to get available models
    fetch('/llm-config/ollama-models/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            server_url: serverUrl
        })
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
        
        if (data.success) {
            updateModelDropdown(data.models);
            showAlert(`✅ Found ${data.models.length} models`, 'success');
        } else {
            showAlert(data.message, 'danger');
        }
    })
    .catch(error => {
        btn.innerHTML = originalHTML;
        btn.disabled = false;
        console.error('Error:', error);
        showAlert('❌ Failed to refresh models: ' + error.message, 'danger');
    });
}

// Form submissions
document.getElementById('openai-form').addEventListener('submit', function(e) {
    e.preventDefault();
    saveOpenAIConfig();
});

document.getElementById('ollama-form').addEventListener('submit', function(e) {
    e.preventDefault();
    saveOllamaConfig();
});

function saveOpenAIConfig() {
    const apiKey = document.getElementById('openai-api-key').value;
    const model = document.getElementById('openai-model').value;
    const temperature = document.getElementById('openai-temperature').value;
    const maxTokens = document.getElementById('openai-max-tokens').value;
    const timeout = document.getElementById('openai-timeout').value;
    
    if (!apiKey) {
        showAlert('Please enter your OpenAI API key', 'warning');
        return;
    }
    
    // Show loading - find the submit button in the form
    const btn = document.querySelector('#openai-form button[type="submit"]');
    if (!btn) {
        console.error('Submit button not found!');
        return;
    }
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    btn.disabled = true;
    
    fetch('/llm-config/save-openai/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            api_key: apiKey,
            model: model,
            temperature: parseFloat(temperature),
            max_tokens: parseInt(maxTokens),
            timeout: parseInt(timeout)
        })
    })
    .then(response => response.json())
    .then(data => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        if (data.success) {
            showAlert(data.message, 'success');
            updateCurrentStatus('OpenAI', {
                model: model,
                status: 'Active'
            });
        } else {
            showAlert(data.error || 'Failed to save configuration', 'danger');
        }
    })
    .catch(error => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        console.error('Error:', error);
        showAlert('❌ Failed to save OpenAI configuration: ' + error.message, 'danger');
    });
}

function saveOllamaConfig() {
    console.log('Saving Ollama configuration...');
    const serverUrl = document.getElementById('ollama-url').value;
    const model = document.getElementById('ollama-model').value === 'custom' 
        ? document.getElementById('ollama-custom-model').value 
        : document.getElementById('ollama-model').value;
    const timeout = document.getElementById('ollama-timeout').value;
    const temperature = document.getElementById('ollama-temperature').value;
    const topP = document.getElementById('ollama-top-p').value;
    
    console.log('Configuration:', { serverUrl, model, timeout, temperature, topP });
    
    if (!serverUrl) {
        showAlert('Please enter the Ollama server URL', 'warning');
        return;
    }
    
    if (!model || model === 'custom') {
        showAlert('Please select or enter a model name', 'warning');
        return;
    }
    
    // Show loading on button instead of modal
    const btn = document.querySelector('#ollama-form button[type="submit"]');
    if (!btn) {
        console.error('Submit button not found!');
        return;
    }
    const originalText = btn.innerHTML;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Saving...';
    btn.disabled = true;
    
    console.log('Sending save request...');
    console.log('Request payload:', {
        server_url: serverUrl,
        model: model,
        timeout: parseInt(timeout),
        temperature: parseFloat(temperature),
        top_p: parseFloat(topP)
    });
    
    fetch('/llm-config/save-ollama/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify({
            server_url: serverUrl,
            model: model,
            timeout: parseInt(timeout),
            temperature: parseFloat(temperature),
            top_p: parseFloat(topP)
        })
    })
    .then(response => {
        console.log('Save response status:', response.status);
        console.log('Save response headers:', response.headers);
        if (!response.ok) {
            console.error('Response not OK:', response.status, response.statusText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        return response.json();
    })
    .then(data => {
        console.log('JSON parsing successful');
        return data;
    })
    .then(data => {
        console.log('Save response data:', data);
        console.log('Data type:', typeof data);
        console.log('Data success:', data.success);
        console.log('Data message:', data.message);
        
        btn.innerHTML = originalText;
        btn.disabled = false;
        
        if (data.success) {
            console.log('Success detected, showing success alert...');
            const message = String(data.message || 'Configuration saved successfully');
            console.log('Save success message type:', typeof message, 'value:', message);
            
            // Show both custom alert and browser alert for debugging
            showAlert(message, 'success');
            alert('SUCCESS: ' + message); // Temporary debugging alert
            
            console.log('Updating status...');
            updateCurrentStatus('Ollama', {
                model: model,
                status: 'Active',
                server_url: serverUrl
            });
        } else {
            console.log('Error detected, showing error alert...');
            const errorMessage = String(data.error || 'Failed to save configuration');
            console.log('Save error message type:', typeof errorMessage, 'value:', errorMessage);
            
            // Show both custom alert and browser alert for debugging
            showAlert(errorMessage, 'danger');
            alert('ERROR: ' + errorMessage); // Temporary debugging alert
        }
    })
    .catch(error => {
        btn.innerHTML = originalText;
        btn.disabled = false;
        console.error('Save error:', error);
        console.error('Error type:', typeof error);
        console.error('Error stack:', error.stack);
        
        let errorMessage = 'Unknown error';
        if (error.message) {
            errorMessage = error.message;
        } else if (typeof error === 'string') {
            errorMessage = error;
        }
        
        showAlert('Failed to save Ollama configuration: ' + errorMessage, 'danger');
        alert('SAVE ERROR: ' + errorMessage); // Temporary debugging alert
    });
}

// Temperature value updates
document.getElementById('openai-temperature').addEventListener('input', function() {
    document.getElementById('temp-value').textContent = this.value;
});

document.getElementById('ollama-temperature').addEventListener('input', function() {
    document.getElementById('ollama-temp-value').textContent = this.value;
});

document.getElementById('ollama-top-p').addEventListener('input', function() {
    document.getElementById('ollama-top-p-value').textContent = this.value;
});

// Custom model input toggle
document.getElementById('ollama-model').addEventListener('change', function() {
    const customInput = document.getElementById('custom-model-input');
    if (this.value === 'custom') {
        customInput.style.display = 'block';
    } else {
        customInput.style.display = 'none';
    }
});

// Utility functions
function getCsrfToken() {
    const token = document.querySelector('[name=csrfmiddlewaretoken]')?.value || 
                  document.querySelector('meta[name=csrf-token]')?.getAttribute('content') || '';
    console.log('CSRF Token:', token ? 'Found' : 'Not found');
    if (!token) {
        console.error('CSRF token not found! This will cause API calls to fail.');
        console.log('Available CSRF elements:', document.querySelectorAll('[name=csrfmiddlewaretoken], meta[name=csrf-token]'));
    }
    return token;
}

function showLoadingModal(title, message) {
    document.getElementById('loadingModalMessage').textContent = String(title || 'Processing...');
    document.getElementById('loadingModalSubtext').textContent = String(message || 'Please wait...');
    
    const loadingModal = new bootstrap.Modal(document.getElementById('loadingModal'), {
        backdrop: 'static',
        keyboard: false
    });
    loadingModal.show();
}

function hideLoadingModal() {
    const loadingModalElement = document.getElementById('loadingModal');
    const loadingModal = bootstrap.Modal.getInstance(loadingModalElement);
    if (loadingModal) {
        loadingModal.hide();
    }
}

function showAlert(message, type = 'info') {
    console.log('showAlert called with:', message, type);
    console.log('Message type:', typeof message);
    
    // Ensure parameters are strings and handle various input types
    let safeMessage = 'No message provided';
    if (message !== null && message !== undefined) {
        if (typeof message === 'string') {
            safeMessage = message;
        } else if (message instanceof HTMLElement) {
            // Special handling for HTML elements that might get passed accidentally
            console.error('HTML Element passed to showAlert:', message);
            safeMessage = 'Error: HTML element passed as message';
        } else if (typeof message === 'object' && message.toString) {
            // Handle objects that might have meaningful toString methods
            const stringified = message.toString();
            if (stringified === '[object Object]' || stringified.includes('[object HTML')) {
                console.error('Object with poor toString passed to showAlert:', message);
                safeMessage = 'Error: Invalid object passed as message';
            } else {
                safeMessage = stringified;
            }
        } else {
            // Convert anything else to string safely
            safeMessage = String(message);
        }
    }
    
    const safeType = String(type || 'info');
    
    console.log('Processed alert params:', safeMessage, safeType);
    
    // Remove existing alerts
    const existingAlerts = document.querySelectorAll('.alert-notification');
    existingAlerts.forEach(alert => alert.remove());
    
    // Create new alert
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${safeType} alert-dismissible fade show alert-notification mt-3`;
    alertDiv.innerHTML = `
        <i class="fas fa-${getAlertIcon(safeType)}"></i> ${safeMessage}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    // Insert after current status
    const statusDiv = document.getElementById('current-status');
    console.log('Status div found:', !!statusDiv);
    
    if (statusDiv) {
        statusDiv.parentNode.insertBefore(alertDiv, statusDiv.nextSibling);
        console.log('Alert inserted after status div');
    } else {
        // Fallback: append to body
        document.body.appendChild(alertDiv);
        console.log('Alert appended to body');
    }
    
    console.log('Alert element:', alertDiv);
    console.log('Alert added to DOM, classes:', alertDiv.className);
    
    // Auto-dismiss after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
            console.log('Alert auto-dismissed');
        }
    }, 5000);
    
    // Also try a simple browser alert as fallback for debugging
    if (window.location.search.includes('debug=true')) {
        setTimeout(() => {
            alert(`Debug: ${safeMessage}`);
        }, 100);
    }
}

function getAlertIcon(type) {
    const icons = {
        'success': 'check-circle',
        'danger': 'exclamation-triangle',
        'warning': 'exclamation-triangle',
        'info': 'info-circle'
    };
    return icons[type] || 'info-circle';
}

function updateCurrentStatus(provider, modelInfo) {
    // Ensure parameters are safe strings/objects
    const safeProvider = String(provider || 'Unknown');
    const safeModelInfo = modelInfo || {};
    
    console.log('Updating current status for:', safeProvider, safeModelInfo);
    let statusDiv = document.getElementById('current-status');
    
    if (!statusDiv) {
        console.error('Status div not found! Creating one...');
        // Create the status div if it doesn't exist
        statusDiv = document.createElement('div');
        statusDiv.id = 'current-status';
        statusDiv.className = 'alert alert-secondary mt-4';
        statusDiv.innerHTML = '<i class="fas fa-info-circle"></i> No LLM provider configured yet.';
        
        // Find a good place to insert it
        const configSection = document.getElementById('provider-config');
        if (configSection) {
            configSection.parentNode.insertBefore(statusDiv, configSection.nextSibling);
        } else {
            // Fallback: append to the card body
            const cardBody = document.querySelector('.card-body');
            if (cardBody) {
                cardBody.appendChild(statusDiv);
            }
        }
        console.log('Created new status div');
    }
    
    try {
        statusDiv.className = 'alert alert-success';
        const serverInfo = safeModelInfo.server_url ? 
            `<strong>Server:</strong> ${String(safeModelInfo.server_url)}<br>` : '';
        
        statusDiv.innerHTML = `
            <h6><i class="fas fa-check-circle"></i> ${safeProvider} Configuration Active</h6>
            <div class="row">
                <div class="col-md-6">
                    <strong>Provider:</strong> ${safeProvider}<br>
                    <strong>Model:</strong> ${String(safeModelInfo.model || 'N/A')}<br>
                    <strong>Status:</strong> ${String(safeModelInfo.status || 'Active')}
                </div>
                <div class="col-md-6">
                    <strong>Response Time:</strong> ${String(safeModelInfo.response_time || 'Good')}<br>
                    ${serverInfo}
                </div>
            </div>
        `;
        console.log('Status updated successfully');
    } catch (error) {
        console.error('Error updating status:', error);
        statusDiv.className = 'alert alert-danger';
        statusDiv.innerHTML = `<i class="fas fa-exclamation-triangle"></i> Error updating status: ${error.message}`;
    }
}

function updateModelDropdown(models) {
    const dropdown = document.getElementById('ollama-model');
    const currentValue = dropdown.value;
    
    // Clear existing options except custom
    const options = dropdown.querySelectorAll('option:not([value="custom"])');
    options.forEach(option => option.remove());
    
    // Add new models
    models.forEach(model => {
        const option = document.createElement('option');
        option.value = model.name;
        option.textContent = `${model.name} ${model.size ? `(${formatFileSize(model.size)})` : ''}`;
        dropdown.insertBefore(option, dropdown.querySelector('option[value="custom"]'));
    });
    
    // Restore selected value if it exists
    if (currentValue && models.some(m => m.name === currentValue)) {
        dropdown.value = currentValue;
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

// Simple test function to isolate the issue
function testSaveFunction() {
    console.log('Testing save function...');
    
    const testData = {
        server_url: 'http://localhost:11434',
        model: 'sqlcoder:15b',
        timeout: 60,
        temperature: 0.1,
        top_p: 0.9
    };
    
    console.log('Sending test request with data:', testData);
    
    fetch('/llm-config/save-ollama/', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
        },
        body: JSON.stringify(testData)
    })
    .then(response => {
        console.log('Test response status:', response.status);
        return response.text(); // Get as text first to see raw response
    })
    .then(text => {
        console.log('Raw response text:', text);
        try {
            const data = JSON.parse(text);
            console.log('Parsed JSON:', data);
            if (data.success) {
                alert('TEST SUCCESS: ' + data.message);
            } else {
                alert('TEST ERROR: ' + (data.error || 'Unknown error'));
            }
        } catch (parseError) {
            console.error('JSON parse error:', parseError);
            alert('JSON PARSE ERROR: ' + text);
        }
    })
    .catch(error => {
        console.error('Test fetch error:', error);
        alert('FETCH ERROR: ' + error.message);
    });
}

// Load current configuration on page load
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, initializing...');
    
    // Test alert function to make sure it works
    console.log('Testing alert function...');
    
    // Add a test button to verify alert functionality (for debugging)
    if (window.location.search.includes('debug=true')) {
        const testBtn = document.createElement('button');
        testBtn.textContent = 'Test Alert';
        testBtn.className = 'btn btn-info btn-sm me-2';
        testBtn.onclick = () => showAlert('Test alert message', 'info');
        
        const testSaveBtn = document.createElement('button');
        testSaveBtn.textContent = 'Test Save';
        testSaveBtn.className = 'btn btn-warning btn-sm';
        testSaveBtn.onclick = testSaveFunction;
        
        const cardBody = document.querySelector('.card-body');
        cardBody.appendChild(testBtn);
        cardBody.appendChild(testSaveBtn);
    }
});
</script>

<style>
.provider-card {
    cursor: pointer;
    transition: all 0.3s ease;
}

.provider-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

.provider-card.border-primary.bg-light {
    border-width: 2px !important;
}

.form-range::-webkit-slider-thumb {
    background: #007bff;
}

.form-range::-moz-range-thumb {
    background: #007bff;
}

/* Fallback alert styles in case Bootstrap isn't loaded */
.alert-notification {
    padding: 12px 16px;
    margin: 10px 0;
    border: 1px solid transparent;
    border-radius: 4px;
    position: relative;
    z-index: 1050;
}

.alert-success {
    color: #155724;
    background-color: #d4edda;
    border-color: #c3e6cb;
}

.alert-danger {
    color: #721c24;
    background-color: #f8d7da;
    border-color: #f5c6cb;
}

.alert-warning {
    color: #856404;
    background-color: #fff3cd;
    border-color: #ffeaa7;
}

.alert-info {
    color: #0c5460;
    background-color: #d1ecf1;
    border-color: #bee5eb;
}
</style>

{% endblock %} 