{% extends 'base.html' %}
{% load static %}

{% block title %}Query Results - ConvaBI{% endblock %}

{% block extra_css %}
<script src="https://cdn.plot.ly/plotly-2.35.2.min.js"></script>
<style>
    .chart-type-card {
        cursor: pointer;
        transition: all 0.3s ease;
        border: 2px solid transparent;
        height: 100%;
    }
    .chart-type-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        border-color: #007bff;
    }
    .chart-type-card.active {
        border-color: #007bff;
        background-color: #f8f9ff;
    }
    .chart-type-icon {
        font-size: 2rem;
        margin-bottom: 0.5rem;
        color: #007bff;
    }
    .kpi-card {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        border-radius: 1rem;
        text-align: center;
        margin-bottom: 1rem;
    }
    .kpi-value {
        font-size: 3rem;
        font-weight: bold;
        margin-bottom: 0.5rem;
    }
    .kpi-label {
        font-size: 1.1rem;
        opacity: 0.9;
    }
    .chart-container {
        min-height: 400px;
        background: #f8f9fa;
        border-radius: 0.5rem;
        padding: 1rem;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    .visualization-controls {
        background: white;
        border-radius: 1rem;
        box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        padding: 2rem;
        margin-bottom: 2rem;
    }
    .data-table-container {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
    }
    .dashboard-actions {
        background: linear-gradient(45deg, #28a745, #20c997);
        color: white;
        padding: 1.5rem;
        border-radius: 1rem;
        margin-top: 2rem;
    }
    .query-info-card {
        background: linear-gradient(45deg, #007bff, #6610f2);
        color: white;
        padding: 1.5rem;
        border-radius: 1rem;
        margin-bottom: 2rem;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="{% url 'core:home' %}">Home</a></li>
                    <li class="breadcrumb-item"><a href="{% url 'core:query' %}">Query</a></li>
                    <li class="breadcrumb-item active">Results</li>
                </ol>
            </nav>
            <h1 class="h3 mb-0">
                <i class="fas fa-chart-line text-primary me-2"></i>
                Query Results & Visualization
            </h1>
        </div>
        <div>
            <a href="{% url 'core:query' %}" class="btn btn-outline-secondary">
                <i class="fas fa-plus me-1"></i>New Query
            </a>
            <a href="{% url 'core:query_history' %}" class="btn btn-outline-primary">
                <i class="fas fa-history me-1"></i>History
            </a>
        </div>
    </div>

    <!-- Query Information Card -->
    <div class="query-info-card">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h5 class="mb-2">
                    <i class="fas fa-search me-2"></i>{{ query }}
                </h5>
                <p class="mb-0 opacity-75">
                    <i class="fas fa-clock me-1"></i>Executed: {{ created_at }}
                    <span class="ms-3"><i class="fas fa-stopwatch me-1"></i>{{ execution_time }}s</span>
                </p>
            </div>
            <div class="col-md-4 text-end">
                <button class="btn btn-light" onclick="toggleSQL()">
                    <i class="fas fa-code me-1"></i>View SQL
                </button>
            </div>
        </div>
    </div>

    <!-- SQL Query (collapsed by default) -->
    <div class="collapse mb-3" id="sqlCollapse">
        <div class="card">
            <div class="card-header">
                <h6 class="mb-0">Generated SQL Query</h6>
            </div>
            <div class="card-body">
                <pre class="bg-light p-3 rounded"><code>{{ sql }}</code></pre>
                <button class="btn btn-sm btn-outline-secondary" onclick="copyToClipboard()">
                    <i class="fas fa-copy me-1"></i>Copy SQL
                </button>
            </div>
        </div>
    </div>

    {% if result and result != "No results available" %}
    <!-- Parse and display actual data -->
    <div class="row">
        <!-- Chart Type Selection -->
        <div class="col-12">
            <div class="visualization-controls">
                <h5 class="mb-4">
                    <i class="fas fa-palette me-2"></i>Choose Visualization Type
                </h5>
                
                <div class="row g-3 mb-4">
                    <!-- KPI Card -->
                    <div class="col-md-2">
                        <div class="card chart-type-card" onclick="selectChartType('kpi')" data-chart="kpi">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-tachometer-alt chart-type-icon"></i>
                                <h6 class="card-title mb-0">KPI</h6>
                                <small class="text-muted">Key Metrics</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Bar Chart -->
                    <div class="col-md-2">
                        <div class="card chart-type-card active" onclick="selectChartType('bar')" data-chart="bar">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-chart-bar chart-type-icon"></i>
                                <h6 class="card-title mb-0">Bar Chart</h6>
                                <small class="text-muted">Compare values</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Line Chart -->
                    <div class="col-md-2">
                        <div class="card chart-type-card" onclick="selectChartType('line')" data-chart="line">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-chart-line chart-type-icon"></i>
                                <h6 class="card-title mb-0">Line Chart</h6>
                                <small class="text-muted">Show trends</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Pie Chart -->
                    <div class="col-md-2">
                        <div class="card chart-type-card" onclick="selectChartType('pie')" data-chart="pie">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-chart-pie chart-type-icon"></i>
                                <h6 class="card-title mb-0">Pie Chart</h6>
                                <small class="text-muted">Show parts</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Table -->
                    <div class="col-md-2">
                        <div class="card chart-type-card" onclick="selectChartType('table')" data-chart="table">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-table chart-type-icon"></i>
                                <h6 class="card-title mb-0">Table</h6>
                                <small class="text-muted">Raw data</small>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Area Chart -->
                    <div class="col-md-2">
                        <div class="card chart-type-card" onclick="selectChartType('area')" data-chart="area">
                            <div class="card-body text-center p-3">
                                <i class="fas fa-chart-area chart-type-icon"></i>
                                <h6 class="card-title mb-0">Area Chart</h6>
                                <small class="text-muted">Filled trends</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chart Configuration -->
                <div id="chartConfiguration" class="mt-4">
                    <div class="row">
                        <div class="col-md-4" id="xAxisConfig">
                            <label for="xAxisSelect" class="form-label fw-bold">X-Axis / Category</label>
                            <select class="form-select" id="xAxisSelect" onchange="updateVisualization()">
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-4" id="yAxisConfig">
                            <label for="yAxisSelect" class="form-label fw-bold">Y-Axis / Value</label>
                            <select class="form-select" id="yAxisSelect" onchange="updateVisualization()">
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>
                        <div class="col-md-4">
                            <label for="chartTitle" class="form-label fw-bold">Chart Title</label>
                            <input type="text" class="form-control" id="chartTitle" value="{{ query }}" onchange="updateVisualization()">
                        </div>
                    </div>
                    
                    <!-- KPI Configuration (hidden by default) -->
                    <div id="kpiConfiguration" class="row mt-3" style="display: none;">
                        <div class="col-md-6">
                            <label for="kpiMetric" class="form-label fw-bold">KPI Metric</label>
                            <select class="form-select" id="kpiMetric" onchange="updateVisualization()">
                                <option value="sum">Sum</option>
                                <option value="avg">Average</option>
                                <option value="count">Count</option>
                                <option value="max">Maximum</option>
                                <option value="min">Minimum</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="kpiColumn" class="form-label fw-bold">KPI Column</label>
                            <select class="form-select" id="kpiColumn" onchange="updateVisualization()">
                                <!-- Will be populated by JavaScript -->
                            </select>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Visualization Display -->
    <div class="row">
        <div class="col-lg-9">
            <div class="card">
                <div class="card-body p-0">
                    <!-- KPI Display -->
                    <div id="kpiDisplay" style="display: none;">
                        <div class="kpi-card">
                            <div class="kpi-value" id="kpiValue">0</div>
                            <div class="kpi-label" id="kpiLabel">Metric</div>
                        </div>
                    </div>
                    
                    <!-- Chart Display -->
                    <div id="chartDisplay">
                        <div class="chart-container" id="chartContainer">
                            <div class="text-center">
                                <i class="fas fa-chart-bar fa-3x text-muted mb-3"></i>
                                <p class="text-muted">Chart will appear here</p>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Table Display -->
                    <div id="tableDisplay" style="display: none;">
                        <div class="data-table-container">
                            <table class="table table-striped table-hover mb-0" id="dataTable">
                                <thead class="table-dark sticky-top">
                                    <tr id="tableHeaders">
                                        <!-- Will be populated by JavaScript -->
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <!-- Will be populated by JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Dashboard Actions -->
            <div class="dashboard-actions">
                <div class="row align-items-center">
                    <div class="col-md-8">
                        <h5 class="mb-1">
                            <i class="fas fa-dashboard me-2"></i>Add to Dashboard
                        </h5>
                        <p class="mb-0 opacity-75">Save this visualization to a dashboard for easy access</p>
                    </div>
                    <div class="col-md-4 text-end">
                        <button class="btn btn-light btn-lg" onclick="showDashboardModal()">
                            <i class="fas fa-plus me-2"></i>Add to Dashboard
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar -->
        <div class="col-lg-3">
            <!-- Data Info -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>Data Summary
                    </h6>
                </div>
                <div class="card-body">
                    <div class="row text-center">
                        <div class="col-6">
                            <div class="fw-bold h4 text-primary" id="rowCount">-</div>
                            <small class="text-muted">Rows</small>
                        </div>
                        <div class="col-6">
                            <div class="fw-bold h4 text-success" id="columnCount">-</div>
                            <small class="text-muted">Columns</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Export Options -->
            <div class="card mb-3">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-download me-2"></i>Export Options
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-primary btn-sm" onclick="exportChart()">
                            <i class="fas fa-image me-1"></i>Export as PNG
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="exportData()">
                            <i class="fas fa-file-csv me-1"></i>Export as CSV
                        </button>
                        <button class="btn btn-outline-info btn-sm" onclick="shareVisualization()">
                            <i class="fas fa-share me-1"></i>Share Link
                        </button>
                    </div>
                </div>
            </div>

            <!-- Quick Actions -->
            <div class="card">
                <div class="card-header">
                    <h6 class="mb-0">
                        <i class="fas fa-bolt me-2"></i>Quick Actions
                    </h6>
                </div>
                <div class="card-body">
                    <div class="d-grid gap-2">
                        <button class="btn btn-outline-secondary btn-sm" onclick="modifyQuery()">
                            <i class="fas fa-edit me-1"></i>Modify Query
                        </button>
                        <button class="btn btn-outline-warning btn-sm" onclick="saveQuery()">
                            <i class="fas fa-save me-1"></i>Save Query
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% else %}
    <!-- No Data State -->
    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card">
                <div class="card-body text-center py-5">
                    <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                    <h4>No Data Found</h4>
                    <p class="text-muted">{{ result }}</p>
                    <a href="{% url 'core:query' %}" class="btn btn-primary">
                        <i class="fas fa-arrow-left me-1"></i>Try Another Query
                    </a>
                </div>
            </div>
        </div>
    </div>
    {% endif %}
</div>

<!-- Dashboard Modal -->
<div class="modal fade" id="dashboardModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Add to Dashboard</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="dashboardForm">
                    <div class="mb-3">
                        <label for="dashboardSelect" class="form-label">Select Dashboard</label>
                        <select class="form-select" id="dashboardSelect" required>
                            <option value="">Choose a dashboard...</option>
                            <option value="new">Create New Dashboard</option>
                        </select>
                    </div>
                    <div class="mb-3" id="newDashboardGroup" style="display: none;">
                        <label for="newDashboardName" class="form-label">New Dashboard Name</label>
                        <input type="text" class="form-control" id="newDashboardName" placeholder="My Business Dashboard">
                    </div>
                    <div class="mb-3">
                        <label for="widgetTitle" class="form-label">Widget Title</label>
                        <input type="text" class="form-control" id="widgetTitle" value="{{ query }}" required>
                    </div>
                    <div class="mb-3">
                        <label for="widgetDescription" class="form-label">Description (optional)</label>
                        <textarea class="form-control" id="widgetDescription" rows="2" placeholder="Brief description of this chart..."></textarea>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addToDashboard()">
                    <i class="fas fa-plus me-1"></i>Add Widget
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Global variables
let currentChartType = 'bar';
let resultData = null;

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Parse the result data
    parseResultData();
    setupDashboardForm();
    if (resultData) {
        updateVisualization();
    }
});

// Parse result data from the template
function parseResultData() {
    try {
        // Get result text from template
        const resultText = `{{ result|escapejs }}`;
        
        console.log('Raw result text:', resultText);
        
        if (resultText && resultText !== "No results available") {
            // Try to parse as JSON first
            if (resultText.startsWith('{') || resultText.startsWith('[')) {
                try {
                    const parsed = JSON.parse(resultText);
                    console.log('Parsed JSON:', parsed);
                    
                    if (parsed.data && parsed.columns) {
                        // Standard format with columns and data
                        resultData = {
                            columns: parsed.columns,
                            rows: parsed.data
                        };
                    } else if (parsed.data && Array.isArray(parsed.data)) {
                        // Data array with inferred columns
                        if (parsed.data.length > 0) {
                            if (typeof parsed.data[0] === 'object') {
                                resultData = {
                                    columns: Object.keys(parsed.data[0]),
                                    rows: parsed.data.map(obj => Object.values(obj))
                                };
                            } else {
                                resultData = {
                                    columns: ['Value'],
                                    rows: parsed.data.map(val => [val])
                                };
                            }
                        }
                    } else if (Array.isArray(parsed)) {
                        // Direct array format
                        if (parsed.length > 0) {
                            if (typeof parsed[0] === 'object') {
                                resultData = {
                                    columns: Object.keys(parsed[0]),
                                    rows: parsed.map(obj => Object.values(obj))
                                };
                            } else if (Array.isArray(parsed[0])) {
                                // Array of arrays
                                resultData = {
                                    columns: parsed[0].map((_, i) => `Column ${i + 1}`),
                                    rows: parsed
                                };
                            } else {
                                resultData = {
                                    columns: ['Value'],
                                    rows: parsed.map(val => [val])
                                };
                            }
                        }
                    } else if (typeof parsed === 'object') {
                        // Single object result
                        resultData = {
                            columns: Object.keys(parsed),
                            rows: [Object.values(parsed)]
                        };
                    }
                } catch (parseError) {
                    console.log('JSON parse failed:', parseError);
                    // Try as plain text with potential numeric values
                    const lines = resultText.split('\n').filter(line => line.trim());
                    if (lines.length > 0) {
                        // Check if it looks like a single number
                        const trimmed = resultText.trim();
                        if (!isNaN(trimmed) && trimmed !== '') {
                            resultData = {
                                columns: ['Total'],
                                rows: [[parseFloat(trimmed)]]
                            };
                        } else {
                            resultData = {
                                columns: ['Result'],
                                rows: lines.map(line => [line.trim()])
                            };
                        }
                    }
                }
            } else {
                // Plain text - check if it's a number or structured data
                const trimmed = resultText.trim();
                if (!isNaN(trimmed) && trimmed !== '') {
                    // It's a number
                    resultData = {
                        columns: ['Total'],
                        rows: [[parseFloat(trimmed)]]
                    };
                } else {
                    // Try to parse as structured text
                    const lines = resultText.split('\n').filter(line => line.trim());
                    resultData = {
                        columns: ['Result'],
                        rows: lines.map(line => [line.trim()])
                    };
                }
            }
        }
        
        // Fallback if no data was parsed
        if (!resultData || !resultData.columns || !resultData.rows) {
            resultData = {
                columns: ['Value'],
                rows: [['No data available']]
            };
        }
        
        console.log('Final resultData:', resultData);
        
        if (resultData) {
            populateColumnSelectors();
            updateDataSummary();
        }
    } catch (e) {
        console.error('Error parsing result data:', e);
        resultData = {
            columns: ['Value'],
            rows: [['Error parsing data']]
        };
        populateColumnSelectors();
        updateDataSummary();
    }
}

// Populate column selectors
function populateColumnSelectors() {
    if (!resultData || !resultData.columns) return;
    
    const xAxisSelect = document.getElementById('xAxisSelect');
    const yAxisSelect = document.getElementById('yAxisSelect');
    const kpiColumn = document.getElementById('kpiColumn');
    
    // Clear existing options
    [xAxisSelect, yAxisSelect, kpiColumn].forEach(select => {
        if (select) select.innerHTML = '';
    });
    
    // Add options
    resultData.columns.forEach((column, index) => {
        [xAxisSelect, yAxisSelect, kpiColumn].forEach(select => {
            if (select) {
                const option = document.createElement('option');
                option.value = column;
                option.textContent = column;
                if (index === 0 && select === xAxisSelect) option.selected = true;
                if (index === 1 && select === yAxisSelect) option.selected = true;
                select.appendChild(option);
            }
        });
    });
}

// Update data summary
function updateDataSummary() {
    if (!resultData) return;
    
    const rowCountEl = document.getElementById('rowCount');
    const columnCountEl = document.getElementById('columnCount');
    
    if (rowCountEl) rowCountEl.textContent = resultData.rows ? resultData.rows.length : 0;
    if (columnCountEl) columnCountEl.textContent = resultData.columns ? resultData.columns.length : 0;
}

// Chart type selection
function selectChartType(chartType) {
    currentChartType = chartType;
    
    // Update UI
    document.querySelectorAll('.chart-type-card').forEach(card => {
        card.classList.remove('active');
    });
    const selectedCard = document.querySelector(`[data-chart="${chartType}"]`);
    if (selectedCard) selectedCard.classList.add('active');
    
    // Show/hide configuration options
    const kpiConfig = document.getElementById('kpiConfiguration');
    const xAxisConfig = document.getElementById('xAxisConfig');
    const yAxisConfig = document.getElementById('yAxisConfig');
    
    if (chartType === 'kpi') {
        if (kpiConfig) kpiConfig.style.display = 'flex';
        if (xAxisConfig) xAxisConfig.style.display = 'none';
        if (yAxisConfig) yAxisConfig.style.display = 'none';
    } else {
        if (kpiConfig) kpiConfig.style.display = 'none';
        if (xAxisConfig) xAxisConfig.style.display = 'block';
        if (yAxisConfig) yAxisConfig.style.display = 'block';
    }
    
    updateVisualization();
}

// Update visualization based on current settings
function updateVisualization() {
    const chartDisplay = document.getElementById('chartDisplay');
    const tableDisplay = document.getElementById('tableDisplay');
    const kpiDisplay = document.getElementById('kpiDisplay');
    
    // Hide all displays
    if (chartDisplay) chartDisplay.style.display = 'none';
    if (tableDisplay) tableDisplay.style.display = 'none';
    if (kpiDisplay) kpiDisplay.style.display = 'none';
    
    if (currentChartType === 'table') {
        if (tableDisplay) tableDisplay.style.display = 'block';
        updateTable();
    } else if (currentChartType === 'kpi') {
        if (kpiDisplay) kpiDisplay.style.display = 'block';
        updateKPI();
    } else {
        if (chartDisplay) chartDisplay.style.display = 'block';
        updateChart();
    }
}

// Update table display
function updateTable() {
    if (!resultData) return;
    
    const headers = document.getElementById('tableHeaders');
    const body = document.getElementById('tableBody');
    
    if (headers) {
        headers.innerHTML = '';
        resultData.columns.forEach(column => {
            const th = document.createElement('th');
            th.textContent = column;
            headers.appendChild(th);
        });
    }
    
    if (body) {
        body.innerHTML = '';
        resultData.rows.forEach(row => {
            const tr = document.createElement('tr');
            row.forEach(cell => {
                const td = document.createElement('td');
                td.textContent = cell;
                tr.appendChild(td);
            });
            body.appendChild(tr);
        });
    }
}

// Update KPI display
function updateKPI() {
    const metricSelect = document.getElementById('kpiMetric');
    const columnSelect = document.getElementById('kpiColumn');
    
    if (!metricSelect || !columnSelect || !resultData) {
        console.log('KPI update skipped - missing elements or data');
        return;
    }
    
    const metric = metricSelect.value;
    const column = columnSelect.value;
    
    console.log('Updating KPI with metric:', metric, 'column:', column);
    console.log('Available columns:', resultData.columns);
    console.log('Data rows:', resultData.rows);
    
    const columnIndex = resultData.columns.indexOf(column);
    if (columnIndex === -1) {
        console.log('Column not found:', column);
        return;
    }
    
    const values = resultData.rows.map(row => {
        const val = parseFloat(row[columnIndex]);
        console.log('Processing value:', row[columnIndex], '-> parsed:', val);
        return isNaN(val) ? 0 : val;
    });
    
    console.log('Extracted values:', values);
    
    let kpiValue = 0;
    switch (metric) {
        case 'sum':
            kpiValue = values.reduce((a, b) => a + b, 0);
            break;
        case 'avg':
            kpiValue = values.reduce((a, b) => a + b, 0) / values.length;
            break;
        case 'count':
            kpiValue = values.length;
            break;
        case 'max':
            kpiValue = Math.max(...values);
            break;
        case 'min':
            kpiValue = Math.min(...values);
            break;
    }
    
    console.log('Calculated KPI value:', kpiValue);
    
    const kpiValueEl = document.getElementById('kpiValue');
    const kpiLabelEl = document.getElementById('kpiLabel');
    
    if (kpiValueEl) {
        const formattedValue = formatKPIValue(kpiValue, column, '{{ query }}');
        kpiValueEl.textContent = formattedValue;
        console.log('Updated KPI display with:', formattedValue);
    }
    
    if (kpiLabelEl) {
        kpiLabelEl.textContent = `${metric.toUpperCase()} of ${column}`;
    }
}

function formatKPIValue(value, columnName = '', queryContext = '') {
    if (typeof value !== 'number' || isNaN(value)) {
        return '0';
    }
    
    // Smart currency detection based on column names and context
    const currencyIndicators = [
        'price', 'cost', 'amount', 'revenue', 'profit', 'salary', 'wage', 'fee', 
        'payment', 'budget', 'expense', 'income', 'sales', 'earnings', 'value',
        'total_amount', 'total_cost', 'total_price', 'total_sales', 'total_revenue'
    ];
    
    const countIndicators = [
        'count', 'total_records', 'records', 'rows', 'entries', 'items', 'number',
        'quantity', 'qty', 'units', 'id', 'index', 'rank', 'position', 'score'
    ];
    
    // Check if this should be currency based on column name or query
    const columnLower = (columnName || '').toLowerCase();
    const queryLower = (queryContext || '').toLowerCase();
    const combined = `${columnLower} ${queryLower}`;
    
    // Determine format type
    let formatType = 'number'; // default
    
    if (currencyIndicators.some(indicator => combined.includes(indicator))) {
        formatType = 'currency';
    } else if (countIndicators.some(indicator => combined.includes(indicator))) {
        formatType = 'count';
    }
    
    // Format based on type
    const absValue = Math.abs(value);
    
    switch (formatType) {
        case 'currency':
            if (absValue >= 1000000) {
                return (value >= 0 ? '$' : '-$') + (absValue / 1000000).toFixed(1) + 'M';
            } else if (absValue >= 1000) {
                return (value >= 0 ? '$' : '-$') + (absValue / 1000).toFixed(1) + 'K';
            } else {
                return new Intl.NumberFormat('en-US', {
                    style: 'currency',
                    currency: 'USD',
                    minimumFractionDigits: 2,
                    maximumFractionDigits: 2
                }).format(value);
            }
            
        case 'count':
        default:
            // Plain number formatting for counts, IDs, etc.
            if (absValue >= 1000000) {
                return (absValue / 1000000).toFixed(1) + 'M';
            } else if (absValue >= 1000) {
                return (absValue / 1000).toFixed(1) + 'K';
            } else {
                return Math.round(value).toLocaleString();
            }
    }
}

// Update chart
function updateChart() {
    const xAxisSelect = document.getElementById('xAxisSelect');
    const yAxisSelect = document.getElementById('yAxisSelect');
    const titleInput = document.getElementById('chartTitle');
    
    if (!xAxisSelect || !yAxisSelect || !resultData) return;
    
    const xAxis = xAxisSelect.value;
    const yAxis = yAxisSelect.value;
    const title = titleInput ? titleInput.value : 'Chart';
    
    createChartFromData(resultData, currentChartType, xAxis, yAxis, title);
}

// Create chart from data
function createChartFromData(data, chartType, xColumn, yColumn, title) {
    const container = document.getElementById('chartContainer');
    if (!container || typeof Plotly === 'undefined') {
        showPlaceholderChart();
        return;
    }
    
    // Get column indices
    const xIndex = data.columns.indexOf(xColumn);
    const yIndex = data.columns.indexOf(yColumn);
    
    if (xIndex === -1 || yIndex === -1) {
        showPlaceholderChart();
        return;
    }
    
    // Extract data
    const xValues = data.rows.map(row => row[xIndex]);
    const yValues = data.rows.map(row => row[yIndex]);
    
    // Create Plotly trace based on chart type
    let trace, layout;
    
    if (chartType === 'bar') {
        trace = {
            x: xValues,
            y: yValues,
            type: 'bar',
            marker: { color: '#007bff' }
        };
    } else if (chartType === 'line') {
        trace = {
            x: xValues,
            y: yValues,
            type: 'scatter',
            mode: 'lines+markers',
            line: { color: '#007bff' }
        };
    } else if (chartType === 'pie') {
        trace = {
            labels: xValues,
            values: yValues,
            type: 'pie'
        };
    } else if (chartType === 'area') {
        trace = {
            x: xValues,
            y: yValues,
            type: 'scatter',
            mode: 'lines',
            fill: 'tonexty',
            line: { color: '#007bff' }
        };
    } else {
        // Default to bar
        trace = {
            x: xValues,
            y: yValues,
            type: 'bar',
            marker: { color: '#007bff' }
        };
    }
    
    layout = {
        title: title || 'Chart',
        xaxis: { title: xColumn },
        yaxis: { title: yColumn },
        margin: { l: 50, r: 50, t: 50, b: 50 },
        font: { size: 12 }
    };
    
    container.innerHTML = '';
    Plotly.newPlot(container, [trace], layout, {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d']
    });
}

// Show placeholder chart
function showPlaceholderChart() {
    const container = document.getElementById('chartContainer');
    if (container) {
        container.innerHTML = `
            <div class="text-center">
                <i class="fas fa-chart-${currentChartType} fa-3x text-muted mb-3"></i>
                <p class="text-muted">${currentChartType.charAt(0).toUpperCase() + currentChartType.slice(1)} chart will appear here</p>
            </div>
        `;
    }
}

// Dashboard modal functions
function showDashboardModal() {
    const modal = new bootstrap.Modal(document.getElementById('dashboardModal'));
    modal.show();
}

// Dashboard form handling
function setupDashboardForm() {
    const dashboardSelect = document.getElementById('dashboardSelect');
    const newDashboardGroup = document.getElementById('newDashboardGroup');
    
    if (dashboardSelect) {
        dashboardSelect.addEventListener('change', function() {
            if (newDashboardGroup) {
                newDashboardGroup.style.display = this.value === 'new' ? 'block' : 'none';
            }
        });
    }
}

function addToDashboard() {
    const dashboardSelect = document.getElementById('dashboardSelect');
    const widgetTitle = document.getElementById('widgetTitle');
    
    if (!dashboardSelect || !dashboardSelect.value) {
        showAlert('warning', 'Please select a dashboard');
        return;
    }
    
    if (!widgetTitle || !widgetTitle.value) {
        showAlert('warning', 'Please enter a widget title');
        return;
    }
    
    // Close modal and show success
    const modal = bootstrap.Modal.getInstance(document.getElementById('dashboardModal'));
    if (modal) modal.hide();
    
    showAlert('success', 'Widget added to dashboard successfully!');
}

// Utility functions
function toggleSQL() {
    const sqlCollapse = new bootstrap.Collapse(document.getElementById('sqlCollapse'));
    sqlCollapse.toggle();
}

function copyToClipboard() {
    const sqlText = `{{ sql|escapejs }}`;
    navigator.clipboard.writeText(sqlText).then(() => {
        showAlert('success', 'SQL copied to clipboard!');
    }).catch(err => {
        showAlert('danger', 'Failed to copy SQL');
    });
}

function exportChart() {
    const element = document.getElementById('chartContainer');
    if (element && typeof Plotly !== 'undefined') {
        Plotly.downloadImage(element, {
            format: 'png',
            width: 1200,
            height: 800,
            filename: 'chart'
        });
    }
}

function exportData() {
    if (!resultData) return;
    
    const csvContent = convertToCSV(resultData);
    const blob = new Blob([csvContent], { type: 'text/csv' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'query_results.csv';
    a.click();
    window.URL.revokeObjectURL(url);
}

function convertToCSV(data) {
    const headers = data.columns.join(',');
    const rows = data.rows.map(row => row.join(','));
    return [headers, ...rows].join('\n');
}

function shareVisualization() {
    const shareUrl = window.location.href;
    navigator.clipboard.writeText(shareUrl).then(() => {
        showAlert('success', 'Visualization URL copied to clipboard!');
    });
}

function modifyQuery() {
    const currentQuery = "{{ query|escapejs }}";
    const encodedQuery = encodeURIComponent(currentQuery);
    window.location.href = `/query/?q=${encodedQuery}`;
}

function saveQuery() {
    showAlert('info', 'Query saved to history');
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.parentNode.removeChild(alertDiv);
        }
    }, 5000);
}
</script>

    <!-- Debug Panel (only visible in console) -->
    <script>
    // Enhanced debugging
    function debugDataFlow() {
        console.log('=== DATA FLOW DEBUG ===');
        console.log('Template result variable:', `{{ result|escapejs }}`);
        console.log('Current resultData:', window.resultData || 'Not set');
        
        if (window.resultData) {
            console.log('Columns:', window.resultData.columns);
            console.log('Rows:', window.resultData.rows);
            console.log('First row values:', window.resultData.rows[0]);
        }
        
        const kpiValue = document.getElementById('kpiValue');
        if (kpiValue) {
            console.log('Current KPI display:', kpiValue.textContent);
        }
        
        return window.resultData;
    }
    
    // Make debug function globally available
    window.debugDataFlow = debugDataFlow;
    
    // Auto-debug when page loads
    document.addEventListener('DOMContentLoaded', function() {
        setTimeout(debugDataFlow, 1000);
    });
    </script>
{% endblock %}
